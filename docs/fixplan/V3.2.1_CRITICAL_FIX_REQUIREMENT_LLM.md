# v3.2.1 긴급 수정: REQUIREMENT Intent LLM 호출 추가

**작업일시**: 2026-01-27  
**우선순위**: 🚨 CRITICAL  
**목적**: REQUIREMENT intent에서 "에이전트 3개" 오답 제거 + 자연스러운 대화 복원

---

## 🚨 긴급 문제 상황

### 문제 1: "프로젝트 등록하고 싶다" → "에이전트 3개 등록되어 있다"
```
사용자: 프로젝트 등록하고 싶은데 어떡해?
AI: 현재 3개 에이전트가 등록되어 있습니다.  ← 잘못된 응답!
```

- **기대**: 프로젝트 생성 방법 안내
- **실제**: 에이전트 개수만 출력
- **원인**: REQUIREMENT intent가 **LLM을 호출하지 않고 고정 템플릿만 사용**

### 문제 2: "안녕하세요 무엇을 도와드릴까요" 무한 반복
```
사용자: 그거 좀 더 자세히 설명해줘
AI: 안녕하세요. 무엇을 도와드릴까요?  ← 반복!

사용자: 아까 말한 프로젝트 말이야
AI: 안녕하세요. 무엇을 도와드릴까요?  ← 계속 반복!
```

- **원인**: LLM 호출 실패 시 fallback 메시지
- **근본 원인**: REQUIREMENT가 LLM을 호출하지 않아, 맥락 없이 고정 응답만 반복

---

## 🔍 근본 원인 분석

### AS-IS 아키텍처 (문제)

```
사용자 입력: "프로젝트 등록하고 싶다"
     ↓
Intent Classification → REQUIREMENT
     ↓
response_builder ONLY (LLM 호출 없음!)
     ↓
고정 템플릿: "현재 3개 에이전트가 등록되어 있습니다."
     ↓
사용자 혼란! (프로젝트를 물었는데 에이전트 답변)
```

### 코드 레벨 문제

#### 1. `v32_stream_message_refactored.py` Line 85
```python
# AS-IS (문제)
if ctx.primary_intent in ["NATURAL", "TOPIC_SHIFT"]:
    # LLM 호출
    ...
# REQUIREMENT는 LLM 호출하지 않음!
```

#### 2. `response_builder.py` Line 148-158
```python
# AS-IS (문제)
elif ctx.primary_intent == "REQUIREMENT":
    # Draft → MES 반영 안내
    if ctx.mes_changed:
        response_parts.append("아까 말씀하신 내용을 설계 초안에 먼저 반영해 두었습니다.\n\n")
    
    # MES 진행률 안내 (간단하게)
    agents_count = len(ctx.mes.get("agents", []))
    if agents_count > 0:
        response_parts.append(f"현재 {agents_count}개 에이전트가 등록되어 있습니다.")  # ← 고정 템플릿!
    else:
        response_parts.append("에이전트 구성을 시작하세요.")
```

---

## ✅ 해결 방법

### TO-BE 아키텍처 (해결)

```
사용자 입력: "프로젝트 등록하고 싶다"
     ↓
Intent Classification → REQUIREMENT
     ↓
LLM 호출 (맥락 + MES 정보 포함!)
     ↓
자연스러운 응답: "프로젝트를 생성하시려면..."
     ↓
사용자 만족! ✅
```

### 수정 사항

#### 1. REQUIREMENT도 LLM 호출 추가

**파일**: `backend/app/services/v32_stream_message_refactored.py`

```python
# Line 84-85
# Before
if ctx.primary_intent in ["NATURAL", "TOPIC_SHIFT"]:

# After
if ctx.primary_intent in ["NATURAL", "TOPIC_SHIFT", "REQUIREMENT"]:
    # REQUIREMENT도 LLM 호출!
```

#### 2. REQUIREMENT 전용 시스템 프롬프트 추가

**파일**: `backend/app/services/v32_stream_message_refactored.py`

```python
# Line 111-137
if ctx.primary_intent == "REQUIREMENT":
    # REQUIREMENT: MES 정보 포함
    agents_count = len(ctx.mes.get("agents", []))
    mes_info = f"현재 프로젝트에는 {agents_count}개의 에이전트가 등록되어 있습니다." if agents_count > 0 else "아직 에이전트가 등록되지 않았습니다."
    
    system_prompt = f"""당신은 프로젝트 관리를 돕는 AI 어시스턴트입니다.

[현재 프로젝트 상태]
{mes_info}

사용자의 요구사항을 이해하고 다음 단계를 안내하세요:
- 프로젝트를 만들고 싶다면: 프로젝트 생성 절차 안내
- 에이전트를 추가하고 싶다면: 에이전트 추가 방법 안내
- 설정을 변경하고 싶다면: 설정 변경 방법 안내

호칭은 '사용자님'을 사용하세요.
자연스럽고 도움이 되는 답변을 제공하세요.
START TASK, READY_TO_START 같은 시스템 메시지는 출력하지 마세요."""
else:
    # NATURAL/TOPIC_SHIFT: 일반 대화
    system_prompt = """당신은 친절한 AI 어시스턴트입니다.
..."""
```

#### 3. response_builder 단순화

**파일**: `backend/app/services/response_builder.py`

```python
# Line 138-147
# Before
if ctx.primary_intent == "NATURAL":
    response_parts.append("")  # LLM이 응답 생성
elif ctx.primary_intent == "REQUIREMENT":
    # 고정 템플릿 (문제!)
    response_parts.append(f"현재 {agents_count}개 에이전트가...")

# After
if ctx.primary_intent in ["NATURAL", "REQUIREMENT"]:
    # NATURAL과 REQUIREMENT 모두 LLM이 응답 생성
    response_parts.append("")  # LLM이 덮어씀
```

---

## 🎯 기대 효과

### Before (문제)
```
사용자: 프로젝트 등록하고 싶은데 어떡해?
AI: 현재 3개 에이전트가 등록되어 있습니다.

사용자: 아니, 프로젝트를 만들고 싶다고!
AI: 안녕하세요. 무엇을 도와드릴까요?  ← 맥락 상실

사용자: (짜증) ...
```

### After (해결!)
```
사용자: 프로젝트 등록하고 싶은데 어떡해?
AI: 프로젝트를 생성하시려면 다음 단계를 따르시면 됩니다:
    1. 프로젝트 이름과 설명을 입력하세요
    2. 필요한 에이전트를 선택하세요
    3. 워크플로우를 구성하세요
    
    어떤 종류의 프로젝트를 만들고 싶으신가요?

사용자: 블로그 프로젝트
AI: 블로그 프로젝트라면 다음 에이전트들이 필요합니다:
    - 기획자: 블로그 구조 설계
    - 개발자: 프론트엔드/백엔드 개발
    - 검수자: 코드 품질 검토
    
    이 구성으로 진행하시겠습니까?

사용자: 응!
AI: 좋습니다! 그럼 블로그 프로젝트 생성을 시작하겠습니다...
```

---

## 📊 변경 사항 상세

### 변경 파일 목록

| **파일** | **변경 내용** | **라인** |
|---|---|---|
| `v32_stream_message_refactored.py` | REQUIREMENT LLM 호출 추가 | L85 |
| `v32_stream_message_refactored.py` | REQUIREMENT 전용 시스템 프롬프트 | L111-137 |
| `response_builder.py` | REQUIREMENT 고정 템플릿 제거 | L138-147 |

### 기술 변경사항

#### 1. LLM 호출 확장
```python
# AS-IS
NATURAL, TOPIC_SHIFT → LLM 호출 ✅
REQUIREMENT → 고정 템플릿 ❌

# TO-BE
NATURAL, TOPIC_SHIFT, REQUIREMENT → LLM 호출 ✅
```

#### 2. Intent별 시스템 프롬프트 차별화
```python
NATURAL → 일반 대화
TOPIC_SHIFT → 주제 전환 대화
REQUIREMENT → MES 정보 포함 + 프로젝트 관리 안내
```

---

## 🧪 테스트 시나리오

### 테스트 1: 프로젝트 생성 요청
```
입력: "프로젝트 등록하고 싶은데 어떡해?"
예상: 프로젝트 생성 절차 안내 (에이전트 개수 X)
검증: ✅ "프로젝트를 생성하시려면..." 으로 시작하는 응답
```

### 테스트 2: 에이전트 추가 요청
```
입력: "에이전트 하나 추가하고 싶어"
예상: 에이전트 추가 방법 안내
검증: ✅ "에이전트를 추가하시려면..." 응답
```

### 테스트 3: 맥락 유지
```
입력 1: "블로그 프로젝트 만들고 싶어"
입력 2: "그거 좀 더 자세히 설명해줘"  ← "그거" = 블로그
예상: 블로그 프로젝트에 대한 상세 설명 (맥락 유지)
검증: ✅ "블로그 프로젝트에 대해 자세히 말씀드리겠습니다..."
```

---

## 📝 시스템 상태

```
✅ 백엔드:   http://0.0.0.0:8002  (PID: 140812)
✅ 워커:     http://127.0.0.1:8002 연결
✅ 프론트엔드: http://localhost:3000

✅ NATURAL → LLM 호출 (대화 히스토리 포함)
✅ TOPIC_SHIFT → LLM 호출
✅ REQUIREMENT → LLM 호출 (MES 정보 포함) ⭐ NEW!
✅ FUNCTION_READ → 실시간 DB 조회
✅ FUNCTION_WRITE → Gate 평가
```

---

## 🎉 결과

### 해결된 문제
1. ✅ **"프로젝트 등록" → "에이전트 3개" 오답 제거**
2. ✅ **"안녕하세요 무엇을 도와드릴까요" 무한 반복 해결**
3. ✅ **REQUIREMENT intent 맥락 유지**
4. ✅ **명칭 혼동 문제 해결** (프로젝트 ≠ 에이전트)

### 개선된 사용자 경험
- ✅ **자연스러운 대화**: 고정 템플릿 제거
- ✅ **맥락 유지**: 이전 대화 기억
- ✅ **명확한 안내**: 프로젝트 vs 에이전트 구분
- ✅ **도움이 되는 응답**: LLM 기반 상황별 안내

---

## 🚀 다음 단계

### 추가 개선 사항 (Optional)
1. **프로젝트 vs 에이전트 명칭 표준화**
   - "프로젝트" = 전체 작업 단위
   - "에이전트" = 프로젝트 내 역할 단위
   - UI/UX에서 명확히 구분

2. **REQUIREMENT 응답 품질 향상**
   - MES 정보를 더 상세히 포함
   - 단계별 가이드 자동 생성

3. **다국어 지원**
   - 한국어/영어 자동 감지
   - 언어별 시스템 프롬프트

---

**이제 "프로젝트 만들고 싶다"고 하면 프로젝트 생성 방법을 안내합니다!** 🎉

**문서 버전**: v3.2.1  
**최종 수정일**: 2026-01-27 (REQUIREMENT LLM 호출 추가)  
**작성자**: MYLLM Development Team
