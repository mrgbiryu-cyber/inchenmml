# ğŸ”„ v2.2 â†’ v3.2 ì™„ì „ ë§ˆì´ê·¸ë ˆì´ì…˜ ê°€ì´ë“œ

**ì‘ì„± ì¼ì‹œ:** 2026-01-27  
**í˜„ì¬ ìƒíƒœ:** v2.2 + Phase 1-5 ì™„ë£Œ (í•˜ì´ë¸Œë¦¬ë“œ ìƒíƒœ)  
**ëª©í‘œ ìƒíƒœ:** v3.2 ì™„ì „ êµ¬í˜„  

---

## ğŸ“Š **í˜„ì¬ êµ¬í˜„ ìƒíƒœ (2026-01-27 ê¸°ì¤€)**

### âœ… **ì™„ë£Œëœ Phase**
- [x] **Phase 1: ì¸í…íŠ¸ ì²´ê³„ ì¬ì„¤ê³„** (MasterIntent enum, _classify_intent)
- [x] **Phase 2: Shadow Mining ì‹œìŠ¤í…œ êµ¬ì¶•** (Draft ëª¨ë¸, shadow_mining.py, database.py)
- [x] **Phase 3: VERIFIED ì‹œìŠ¤í…œ ê°•í™”** (verification_state, verify_execution_ready)
- [x] **Phase 4: Response Builder í›„ì²˜ë¦¬** (clean_response)
- [x] **Phase 5: TTL ë° ì •ë¦¬ ì •ì±…** (draft_cleanup.py)

### â³ **ë¯¸ì™„ë£Œ Phase**
- [ ] **Phase 6: stream_message ì „ì²´ ë¦¬íŒ©í† ë§** (ê°€ì¥ í° ì‘ì—…, 400ì¤„ ì¬ì‘ì„± í•„ìš”)
- [ ] **Phase 7: ë°±ê·¸ë¼ìš´ë“œ ì‘ì—… í†µí•©** (main.pyì— draft_cleanup_task ì¶”ê°€)
- [ ] **Phase 8: í•„ìˆ˜ í…ŒìŠ¤íŠ¸ ì¼€ì´ìŠ¤ ê²€ì¦** (12ê°€ì§€ ì¼€ì´ìŠ¤)

---

## ğŸ¯ **v3.2 í•µì‹¬ ì›ì¹™ (í†µí•©ë³¸)**

### **0. ì „ì²´ ì—­í•  ë¶„ë¦¬ (ë³€ê²½ ë¶ˆê°€ ì›ì¹™)**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      MASTER (UI í”„ë¡¬í”„íŠ¸)                     â”‚
â”‚   ì—­í• : ìì—°ì–´ ì‘ë‹µ + ìš”êµ¬ì‚¬í•­ ì •ë¦¬(MES)                       â”‚
â”‚   ê¸ˆì§€: ì‹¤í–‰ íŠ¸ë¦¬ê±°, DB ì“°ê¸°, ë²„íŠ¼ ìƒì„±, ì—ì´ì „íŠ¸ êµ¬ì„± ì§ì ‘ ì‹¤í–‰  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    EXECUTOR (í•˜ë“œì½”ë”© ì˜ì—­)                   â”‚
â”‚   ì—­í• : ë¬¼ë¦¬ì  ë¬¸ì§€ê¸°                                         â”‚
â”‚   ì¡°ê±´: VERIFIED ìƒíƒœ + confirm_token ì¼ì¹˜ ì‹œë§Œ í—ˆìš©          â”‚
â”‚   í—ˆìš©: ë²„íŠ¼ ìƒì„±, DB Write, ì‹¤í–‰ ì´ë²¤íŠ¸                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                 STATUS_QUERY (í˜„í™© ì¡°íšŒ ì „ìš©)                 â”‚
â”‚   ì—­í• : íŒ©íŠ¸ ì²´í¬ ì „ìš©                                        â”‚
â”‚   ì›ì¹™: ì‹¤ì‹œê°„ DB/Tool ê²°ê³¼ë§Œ ì¶œë ¥, RAG/KG ì°¨ë‹¨               â”‚
â”‚   ì‹¤íŒ¨: "ì¡°íšŒ ë¶ˆê°€"ë¡œ ì¦‰ì‹œ ì¢…ë£Œ                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“ **AS-IS (v2.2) â†’ TO-BE (v3.2) ìƒì„¸ ë¹„êµ**

### **1. ì¸í…íŠ¸ ë¶„ë¥˜ ì²´ê³„**

#### **AS-IS (v2.2): 11ê°€ì§€ Intent**

```python
# backend/app/services/master_agent_service.py (v2.2)
def _classify_intent(self, message: str) -> tuple:
    """
    Returns: (primary_intent, possible_intents)
    """
    # 11ê°€ì§€ Intent:
    # 1. EXECUTION_REQUEST
    # 2. STATUS_QUERY
    # 3. CONFIG_CHANGE
    # 4. READINESS_CHECK
    # 5. CANCEL
    # 6. TOPIC_SHIFT
    # 7. MES_BUILD
    # 8. AFFIRMATIVE_ONLY
    # 9. UNCLEAR
    # 10. USER_CHOICE
    # 11. (default) - ìì—°ì–´
    
    # ë¬¸ì œì :
    # - ë„ˆë¬´ ë§ì€ Intentë¡œ ì¸í•œ ë³µì¡ë„ ì¦ê°€
    # - UNCLEAR + USER_CHOICEë¡œ ì¸í•œ ì„ íƒì§€ ë©”ë‰´ ê°•ì œ ì¶œë ¥
    # - "ì‘", "ì˜ˆ" ê°™ì€ ë‹¨ìˆœ ê¸ì •ë„ ì‹¤í–‰ìœ¼ë¡œ ì˜¤ì¸ ê°€ëŠ¥
```

#### **TO-BE (v3.2): 5ê°€ì§€ Intent**

```python
# backend/app/services/master_agent_service.py (v3.2)
class MasterIntent(str, Enum):
    NATURAL = "NATURAL"           # ìì—°ì–´ ëŒ€í™” (ì¡ë‹´, ê°ì‚¬, ì¸ì‚¬)
    REQUIREMENT = "REQUIREMENT"   # ìš”êµ¬ì‚¬í•­ ì •ë¦¬ (MES ë¹Œë“œ)
    FUNCTION_READ = "FUNCTION_READ"     # ì¡°íšŒ ì „ìš©
    FUNCTION_WRITE = "FUNCTION_WRITE"   # ì‹¤í–‰/ë³€ê²½
    CANCEL = "CANCEL"             # ì·¨ì†Œ
    TOPIC_SHIFT = "TOPIC_SHIFT"   # ì£¼ì œ ë³€ê²½

def _classify_intent(self, message: str) -> MasterIntent:
    """
    ì •ê·œì‹ ê¸°ë°˜ ê·œì¹™ ìš°ì„ 
    Returns: MasterIntent enum (ë‹¨ì¼ ê°’)
    """
    msg = message.strip()
    
    # 1. NATURAL (ìµœìš°ì„ )
    if re.search(r"^(ì•ˆë…•|ê³ ë§ˆì›Œ|ã…‹ã…‹)$", msg):
        return MasterIntent.NATURAL
    
    # 2. CANCEL / TOPIC_SHIFT
    if "ì·¨ì†Œ" in msg or "ì¤‘ë‹¨" in msg:
        return MasterIntent.CANCEL
    
    # 3. FUNCTION_WRITE (ì—„ê²©)
    CONFIRM_TOKENS = ["ì‹¤í–‰ í™•ì •", "ë³€ê²½ í™•ì •", "START TASK ì‹¤í–‰"]
    if any(token in msg for token in CONFIRM_TOKENS):
        return MasterIntent.FUNCTION_WRITE
    
    # 4. FUNCTION_READ
    if re.search(r"(í˜„ì¬|ì§€ê¸ˆ|í˜„í™©).*?(ë³´ì—¬ì¤˜|ì•Œë ¤ì¤˜)", msg):
        return MasterIntent.FUNCTION_READ
    
    # 5. REQUIREMENT
    if re.search(r"(ì •ë¦¬|ìš”ì•½|êµ¬ì²´í™”).*?í•´ì¤˜", msg):
        return MasterIntent.REQUIREMENT
    
    # 6. NATURAL (ê¸°ë³¸ê°’)
    return MasterIntent.NATURAL
```

**ê°œì„  íš¨ê³¼:**
- âœ… Intent ê°œìˆ˜ 11ê°œ â†’ 5ê°œ (54% ê°ì†Œ)
- âœ… ì„ íƒì§€ ë©”ë‰´ ì œê±° (UNCLEAR, USER_CHOICE íê¸°)
- âœ… ìì—°ì–´ëŠ” ìì—°ì–´ë¡œë§Œ ì‘ë‹µ (ë©”ë‰´ ê°•ì œ ì¶œë ¥ X)
- âœ… "ì‘", "ì˜ˆ" ì˜¤ì¸ ë°©ì§€ (NATURALë¡œ ë¶„ë¥˜)

---

### **2. Shadow Mining (ê°€ì¥ í° ì‹ ê·œ ê¸°ëŠ¥)**

#### **AS-IS (v2.2): Shadow Mining ì—†ìŒ**

```python
# v2.2ì—ì„œëŠ” Shadow Miningì´ ì—†ìŒ
# ì‚¬ìš©ìê°€ "ì•„ì´ë””ì–´ í•˜ë‚˜ ìˆì–´"ë¼ê³  ë§í•˜ë©´
# â†’ ì¦‰ì‹œ "ì–´ë–¤ ì•„ì´ë””ì–´ì¸ì§€ ë§ì”€í•´ì£¼ì„¸ìš”" ì§ˆë¬¸
# â†’ ì‚¬ìš©ìê°€ ë‹¤ì‹œ ì„¤ëª…í•´ì•¼ í•¨
```

#### **TO-BE (v3.2): Shadow Mining êµ¬í˜„**

```python
# backend/app/models/master.py (v3.2)
class Draft(BaseModel):
    """Shadow Mining Draft ëª¨ë¸"""
    id: str
    session_id: str
    user_id: str
    project_id: Optional[str]
    status: Literal["UNVERIFIED", "VERIFIED", "MERGED", "EXPIRED"] = "UNVERIFIED"
    category: Literal["í™˜ê²½", "ëª©í‘œ", "ì‚°ì¶œë¬¼", "ì œì•½"]
    content: str
    source: str = "USER_UTTERANCE"
    timestamp: datetime
    ttl_days: int = 7

# backend/app/services/shadow_mining.py (v3.2)
class ShadowMiningService:
    async def extract_design_info(
        self, 
        user_input: str, 
        session_id: str, 
        user_id: str
    ) -> List[Draft]:
        """ìì—°ì–´ì—ì„œ ì„¤ê³„ ì •ë³´ ì¶”ì¶œ"""
        
        # LLM í˜¸ì¶œë¡œ ì„¤ê³„ ì •ë³´ ì¶”ì¶œ
        system_prompt = """
        ì‚¬ìš©ì ì…ë ¥ì—ì„œ í”„ë¡œì íŠ¸ ì„¤ê³„ ê´€ë ¨ ì •ë³´ë¥¼ ì¶”ì¶œí•˜ì„¸ìš”.
        ì¹´í…Œê³ ë¦¬: í™˜ê²½, ëª©í‘œ, ì‚°ì¶œë¬¼, ì œì•½
        
        ì¶œë ¥ í˜•ì‹:
        [
            {"category": "í™˜ê²½", "content": "ë¡œì»¬, íŒŒì´ì¬"},
            {"category": "ì‚°ì¶œë¬¼", "content": "now.py íŒŒì¼"}
        ]
        """
        # ...
        return drafts

# backend/app/core/database.py (v3.2)
async def save_draft_to_rdb(draft: Draft) -> str:
    """Draftë¥¼ PostgreSQLì— ì €ì¥"""
    # drafts í…Œì´ë¸”ì— ì €ì¥
    # ...

async def get_drafts_from_rdb(session_id: str, status: str = "UNVERIFIED") -> List:
    """Draft ì¡°íšŒ"""
    # ...
```

**ì‹œë‚˜ë¦¬ì˜¤ ì˜ˆì‹œ:**

```
ì‚¬ìš©ì: "ì•ˆë…•"
MASTER [NATURAL]: "ì•ˆë…•í•˜ì„¸ìš”, í˜•ë‹˜!" [ë]

ì‚¬ìš©ì: "ì•„ì´ë””ì–´ í•˜ë‚˜ ìˆì–´. ë¡œì»¬ì—ì„œ íŒŒì´ì¬ìœ¼ë¡œ now.py ë§Œë“¤ê³  ì‹¶ì–´"
MASTER [NATURAL + Shadow Mining]:
  ì‘ë‹µ: "ì¢‹ì€ ì•„ì´ë””ì–´ë„¤ìš”! ğŸ˜Š"
  ë‚´ë¶€ ë™ì‘:
    â†’ shadow_mining_service.extract_design_info(...)
    â†’ Draft ìƒì„±:
       {category: "í™˜ê²½", content: "ë¡œì»¬, íŒŒì´ì¬"}
       {category: "ì‚°ì¶œë¬¼", content: "now.py íŒŒì¼"}
    â†’ save_draft_to_rdb(...)

ì‚¬ìš©ì: "ì¢€ ë” êµ¬ì²´ì ìœ¼ë¡œ ì •ë¦¬í•´ì¤˜"
MASTER [REQUIREMENT]:
  ì‘ë‹µ: "í˜•ë‹˜, ì•„ê¹Œ ë§ì”€í•˜ì‹  ë¡œì»¬ í™˜ê²½ê³¼ íŒŒì´ì¬ ê¸°ë°˜ ë‚´ìš©ì„ 
         ì„¤ê³„ ì´ˆì•ˆì— ë¨¼ì € ë°˜ì˜í•´ ë‘ì—ˆìŠµë‹ˆë‹¤."
  ë‚´ë¶€ ë™ì‘:
    â†’ drafts = get_drafts_from_rdb(session_id, "UNVERIFIED")
    â†’ MES ìƒì„±:
       environment: "ë¡œì»¬, íŒŒì´ì¬"
       deliverable: "now.py íŒŒì¼"
       objective: "í˜„ì¬ ì‹œê°„ ì¶œë ¥"
    â†’ Draft ìƒíƒœ ë³€ê²½: UNVERIFIED â†’ MERGED
```

**ê°œì„  íš¨ê³¼:**
- âœ… ìì—°ì–´ ëŒ€í™” íë¦„ ìœ ì§€ (ì§ˆë¬¸ í­ê²© X)
- âœ… ì„¤ê³„ ì •ë³´ ìë™ ì¶”ì¶œ ë° ì„ì‹œ ì €ì¥
- âœ… ë‚˜ì¤‘ì— REQUIREMENT ì‹œ ìë™ ë°˜ì˜

**êµ¬í˜„ í•„ìš” ì‚¬í•­:**
1. PostgreSQL `drafts` í…Œì´ë¸” ìƒì„±
2. `shadow_mining_service` í†µí•© (stream_messageì—ì„œ í˜¸ì¶œ)
3. Draft â†’ MES ë§¤ì¹­ ë¡œì§ êµ¬í˜„

---

### **3. ARMED â†’ VERIFIED ì‹œìŠ¤í…œ**

#### **AS-IS (v2.2): ARMED ìƒíƒœ**

```python
# backend/app/services/master_agent_service.py (v2.2)
def __init__(self):
    self.is_armed: bool = False  # ë‹¨ìˆœ boolean
    self.armed_mes_hash: Optional[str] = None

# stream_messageì—ì„œ
if intent == "READINESS_CHECK":
    check = self._check_completeness(p_data)
    if check["is_complete"]:
        self.is_armed = True
        self.armed_mes_hash = self._get_mes_hash(p_data)
        # [START TASK] ë²„íŠ¼ ìƒì„± JSON ì¶œë ¥
```

**ë¬¸ì œì :**
- `is_armed`ê°€ `True`ì—¬ë„ ì‹¤ì œë¡œ DBë¥¼ ë‹¤ì‹œ ì½ì§€ ì•ŠìŒ
- LLMì´ "READY_TO_START" JSONì„ ì¶œë ¥í•˜ë©´ ë²„íŠ¼ ìƒì„± (ì—„ê²©í•˜ì§€ ì•ŠìŒ)
- "ì‘", "ì˜ˆ"ë¡œë„ ì‹¤í–‰ ê°€ëŠ¥

#### **TO-BE (v3.2): VERIFIED ìƒíƒœ**

```python
# backend/app/services/master_agent_service.py (v3.2)
def __init__(self):
    self.verification_state: Dict[str, Any] = {
        "is_verified": False,
        "mes_hash": None,
        "last_db_check": None,  # timestamp
        "db_check_result": None,  # Tool í˜¸ì¶œ ê²°ê³¼
        "confirm_token": None,
        "project_id": None
    }

async def verify_execution_ready(
    self, 
    project_id: str, 
    confirm_token: str
) -> Dict[str, Any]:
    """
    ì‹¤í–‰ ì¤€ë¹„ ìƒíƒœ ê²€ì¦ (VERIFIED ì¡°ê±´ ì²´í¬)
    
    ì¡°ê±´ (AND):
    1. confirm_token in ["ì‹¤í–‰ í™•ì •", "ë³€ê²½ í™•ì •", "START TASK ì‹¤í–‰"]
    2. ì‹¤ì‹œê°„ DB ì¡°íšŒ ì„±ê³µ
    3. ê²°ê³¼ê°€ ë¹ˆ ê°’ì´ ì•„ë‹˜
    4. ì™„ì „ì„± ì²´í¬ í†µê³¼
    5. ì‹¤í–‰ ê°€ëŠ¥ì„± ì²´í¬ í†µê³¼
    """
    
    # 1. confirm_token ê²€ì¦ (í™”ì´íŠ¸ë¦¬ìŠ¤íŠ¸)
    CONFIRM_TOKENS = ["ì‹¤í–‰ í™•ì •", "ë³€ê²½ í™•ì •", "START TASK ì‹¤í–‰"]
    if confirm_token not in CONFIRM_TOKENS:
        return {"verified": False, "reason": "ì˜ëª»ëœ í™•ì • í† í°"}
    
    # 2. ì‹¤ì‹œê°„ DB ì¡°íšŒ
    project = await neo4j_client.get_project(project_id)
    if not project:
        return {"verified": False, "reason": "í”„ë¡œì íŠ¸ ì¡°íšŒ ì‹¤íŒ¨"}
    
    # 3. ì™„ì „ì„± ì²´í¬
    check = self._check_completeness(project)
    if not check["is_complete"]:
        return {"verified": False, "reason": f"ì„¤ì • ë¯¸ì™„ë£Œ: {check['missing']}"}
    
    # 4. ì‹¤í–‰ ê°€ëŠ¥ì„± ì²´í¬
    capability = await self._check_agent_capability(project_id, "")
    if not capability["can_execute"]:
        return {"verified": False, "reason": "ì‹¤í–‰ ë¶ˆê°€"}
    
    # ëª¨ë“  ê²€ì¦ í†µê³¼
    self.verification_state["is_verified"] = True
    self.verification_state["mes_hash"] = self._get_mes_hash(project)
    self.verification_state["last_db_check"] = datetime.utcnow()
    self.verification_state["confirm_token"] = confirm_token
    
    return {"verified": True}

# stream_messageì—ì„œ (v3.2)
if intent == MasterIntent.FUNCTION_WRITE:
    verify_result = await self.verify_execution_ready(project_id, message)
    if not verify_result["verified"]:
        yield f"âŒ ì‹¤í–‰ ë¶ˆê°€: {verify_result['reason']}"
        return
    
    # ì´ì œì•¼ ë²„íŠ¼ ìƒì„± í—ˆìš©
    yield json.dumps({"status": "READY_TO_START", ...})
```

**ê°œì„  íš¨ê³¼:**
- âœ… confirm_token ì—„ê²© ê²€ì¦ ("ì‹¤í–‰ í™•ì •"ë§Œ ì¸ì •)
- âœ… ì‹¤ì‹œê°„ DB ì¡°íšŒ ê°•ì œ
- âœ… ê²€ì¦ ê²°ê³¼ ìºì‹± (timestamp í¬í•¨)
- âœ… "ì‘", "ì˜ˆ" ì˜¤ì¸ ë°©ì§€

---

### **4. Response Builder í›„ì²˜ë¦¬**

#### **AS-IS (v2.2): ë¶€ë¶„ êµ¬í˜„**

```python
# stream_message ëë¶€ë¶„ (v2.2)
# [RULE 5] Response Builder - ë¶ˆí•„ìš”í•œ ìë™ ë¶€ì°© ì œê±°
full_content = re.sub(r"---\s*MISSION READINESS REPORT\s*---[\s\S]*$", "", full_content)
full_content = re.sub(r'```json\s*\{\s*"status"\s*:\s*"READY_TO_START"[\s\S]*?```', "", full_content)
# ... ì¼ë¶€ íŒ¨í„´ë§Œ ì œê±°
```

**ë¬¸ì œì :**
- `READINESS_CHECK` Intentê°€ ì•„ë‹ ë•Œë§Œ ì œê±°
- LLMì´ ë‹¤ë¥¸ í˜•íƒœë¡œ ì¶œë ¥í•˜ë©´ ì œê±° ì‹¤íŒ¨

#### **TO-BE (v3.2): ì¡°ê±´ë¶€ ë¸”ë¡ ì œê±°**

```python
# backend/app/services/master_agent_service.py (v3.2)
def clean_response(
    self, 
    content: str, 
    intent: MasterIntent, 
    has_confirm_token: bool
) -> str:
    """
    ì¡°ê±´: intent != FUNCTION_WRITE OR confirm_token ë¯¸ì¡´ì¬
    â†’ ëª¨ë“  ìë™ ìƒì„± ë¸”ë¡ ì œê±°
    """
    
    if intent == MasterIntent.FUNCTION_WRITE and has_confirm_token:
        return content  # ê·¸ëŒ€ë¡œ ìœ ì§€
    
    # ê·¸ ì™¸ ëª¨ë“  ê²½ìš°: ìë™ ìƒì„± ë¸”ë¡ ì œê±°
    patterns = [
        r"---\s*MISSION READINESS REPORT\s*---[\s\S]*?(?=\n\n|\Z)",
        r'```json\s*\{\s*"status"\s*:\s*"READY_TO_START"[\s\S]*?```',
        r"## ì¡°ì¹˜ ë°©ë²• ê°€ì´ë“œ[\s\S]*?(?=\n\n|\Z)",
        r"\*\*ê¶Œì¥ ì¡°ì¹˜:\*\*[\s\S]*?(?=\n\n|\Z)",
    ]
    
    for pattern in patterns:
        content = re.sub(pattern, "", content)
    
    return content.strip()

# stream_messageì—ì„œ (v3.2)
final_response = self.clean_response(full_content, intent, has_confirm_token)
yield final_response
```

**ê°œì„  íš¨ê³¼:**
- âœ… ì¡°ê±´ ëª…í™•í™” (FUNCTION_WRITE + confirm_tokenë§Œ ìœ ì§€)
- âœ… íŒ¨í„´ ê°•í™” (ë‹¤ì–‘í•œ í˜•íƒœ ì œê±°)
- âœ… ì—°ì† ë¹ˆ ì¤„ ì •ë¦¬

---

### **5. TTL ë° ì •ë¦¬ ì •ì±…**

#### **AS-IS (v2.2): TTL ì—†ìŒ**

```python
# v2.2ì—ëŠ” Draftê°€ ì—†ìœ¼ë¯€ë¡œ TTLë„ ì—†ìŒ
```

#### **TO-BE (v3.2): TTL êµ¬í˜„**

```python
# backend/app/services/draft_cleanup.py (v3.2)
async def cleanup_expired_drafts_task():
    """
    ë°±ê·¸ë¼ìš´ë“œ ì‘ì—…: ë§Œë£Œëœ Draft ì‚­ì œ
    - 1ì‹œê°„ë§ˆë‹¤ ì‹¤í–‰
    - TTL ê¸°ê°„ (ê¸°ë³¸ 7ì¼) ì´ˆê³¼í•œ UNVERIFIED Draft ì‚­ì œ
    """
    from app.core.database import delete_expired_drafts
    
    while True:
        try:
            deleted_count = await delete_expired_drafts(days=7)
            logger.info(f"âœ… Draft ì •ë¦¬ ì™„ë£Œ: {deleted_count}ê°œ ì‚­ì œ")
        except Exception as e:
            logger.error(f"âŒ Draft ì •ë¦¬ ì‹¤íŒ¨: {e}")
        
        await asyncio.sleep(3600)  # 1ì‹œê°„ ëŒ€ê¸°

async def purge_project_drafts(project_id: str):
    """í”„ë¡œì íŠ¸ ì™„ë£Œ/ì·¨ì†Œ ì‹œ ê´€ë ¨ Draft ì •ë¦¬"""
    # status = 'EXPIRED'ë¡œ ë³€ê²½
    # ...

# backend/app/core/database.py (v3.2)
async def delete_expired_drafts(days: int = 7):
    """ë§Œë£Œëœ Draft ì‚­ì œ (TTL ê¸°ë°˜)"""
    expired_time = datetime.utcnow() - timedelta(days=days)
    # DELETE FROM drafts WHERE status = 'UNVERIFIED' AND timestamp < expired_time
    # ...
```

**ë°±ê·¸ë¼ìš´ë“œ ì‘ì—… í†µí•© í•„ìš”:**

```python
# backend/app/main.py (v3.2)
from app.services.draft_cleanup import cleanup_expired_drafts_task

@app.on_event("startup")
async def startup_event():
    # ê¸°ì¡´ Worker, Redis ì´ˆê¸°í™” ...
    
    # [v3.2] Draft ì •ë¦¬ ë°±ê·¸ë¼ìš´ë“œ ì‘ì—… ì‹œì‘
    asyncio.create_task(cleanup_expired_drafts_task())
```

**ê°œì„  íš¨ê³¼:**
- âœ… UNVERIFIED Draft ìë™ ì •ë¦¬ (7ì¼ í›„)
- âœ… í”„ë¡œì íŠ¸ ì™„ë£Œ ì‹œ Draft purge
- âœ… DB ìš©ëŸ‰ ê´€ë¦¬

---

## ğŸš§ **Phase 6: stream_message ì „ì²´ ë¦¬íŒ©í† ë§ ê°€ì´ë“œ**

### **AS-IS (v2.2): stream_message êµ¬ì¡°**

```python
async def stream_message(self, message, history, project_id, ...):
    # 1. Intent ë¶„ë¥˜ (11ê°€ì§€)
    intent, possible_intents = self._classify_intent(message)
    
    # 2. Intentë³„ ì²˜ë¦¬
    if intent == "USER_CHOICE":  # ì„ íƒì§€ ì²˜ë¦¬
        # ...
    elif intent == "UNCLEAR":  # ì„ íƒì§€ ì œì‹œ
        # ...
    elif intent == "AFFIRMATIVE_ONLY":  # "ì‘/ì˜ˆ" ë‹¨ë… ì…ë ¥
        # ...
    elif intent == "STATUS_QUERY":  # DB ì¡°íšŒ ì „ìš©
        # ...
    elif intent == "READINESS_CHECK":  # ì¤€ë¹„ ì ê²€
        # ...
    elif intent == "CONFIG_CHANGE":  # ì„¤ì • ë³€ê²½
        # ...
    elif intent == "EXECUTION_REQUEST":  # ì‹¤í–‰ ìš”ì²­
        # ...
    elif intent == "CANCEL":  # ì·¨ì†Œ
        # ...
    # ... ê¸°íƒ€
    
    # 3. LLM í˜¸ì¶œ (Tool ì‚¬ìš©)
    # 4. Response Builder í›„ì²˜ë¦¬
```

### **TO-BE (v3.2): stream_message êµ¬ì¡°**

```python
async def stream_message_v32(self, message, history, project_id, ...):
    """
    v3.2 stream_message - 5ê°€ì§€ Intent ê¸°ë°˜
    """
    # 0. ì„¤ì • ë¡œë“œ ë° ì‚¬ìš©ì ë©”ì‹œì§€ ì €ì¥
    self._load_config()
    await save_message_to_rdb("user", message, project_id, thread_id)
    
    # 1. Intent ë¶„ë¥˜ (5ê°€ì§€)
    intent = self._classify_intent(message)  # MasterIntent enum ë°˜í™˜
    print(f"DEBUG: Intent = {intent.value}")
    
    # 2. De-verification ì¡°ê±´ ì²´í¬
    # - MES Hash ë³€ê²½ ê°ì§€
    # - CANCEL / TOPIC_SHIFT ì‹œ VERIFIED ìƒíƒœ í•´ì œ
    p_data = await neo4j_client.get_project(project_id)
    if p_data:
        current_mes_hash = self._get_mes_hash(p_data)
        if (self.verification_state["is_verified"] and 
            self.verification_state["mes_hash"] != current_mes_hash):
            self.verification_state["is_verified"] = False
            yield "âš ï¸ í”„ë¡œì íŠ¸ ì„¤ì •ì´ ë³€ê²½ë˜ì–´ 'í™•ì •' ìƒíƒœê°€ í•´ì œë˜ì—ˆìŠµë‹ˆë‹¤."
    
    # 3. Intentë³„ ì²˜ë¦¬ (v3.2 5ê°€ì§€ Intent)
    
    # ===== NATURAL =====
    if intent == MasterIntent.NATURAL:
        # ìì—°ì–´ ì‘ë‹µë§Œ (ì§§ê³  ì¸ê°„ì )
        natural_responses = {
            "ì•ˆë…•": "ì•ˆë…•í•˜ì„¸ìš”, í˜•ë‹˜! ğŸ˜Š",
            "ê³ ë§ˆì›Œ": "ë³„ë§ì”€ì„ìš”! ë„ì›€ì´ ë˜ì–´ ê¸°ì©ë‹ˆë‹¤.",
            "ã…‹ã…‹": "ã…ã… ğŸ˜„"
        }
        response = natural_responses.get(message.strip(), "ë„¤, í˜•ë‹˜!")
        
        # [Shadow Mining] ì„¤ê³„ ì •ë³´ ì¶”ì¶œ ì‹œë„
        from app.services.shadow_mining import shadow_mining_service
        drafts = await shadow_mining_service.extract_design_info(
            message, session_id, user.id, project_id
        )
        if drafts:
            from app.core.database import save_draft_to_rdb
            for draft in drafts:
                await save_draft_to_rdb(draft)
            print(f"DEBUG: Shadow Mining - {len(drafts)}ê°œ Draft ì €ì¥")
        
        yield response
        await save_message_to_rdb("assistant", response, project_id, thread_id)
        return
    
    # ===== CANCEL / TOPIC_SHIFT =====
    if intent in [MasterIntent.CANCEL, MasterIntent.TOPIC_SHIFT]:
        self.verification_state["is_verified"] = False
        response = "âœ… ì‘ì—… ê³„íšì´ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤." if intent == MasterIntent.CANCEL else "âœ… ëŒ€í™” ì£¼ì œê°€ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤."
        yield response
        await save_message_to_rdb("assistant", response, project_id, thread_id)
        return
    
    # ===== FUNCTION_READ (ì¡°íšŒ ì „ìš©) =====
    if intent == MasterIntent.FUNCTION_READ:
        # RAG / KG ì°¨ë‹¨, ì‹¤ì‹œê°„ DB/Toolë§Œ ì‚¬ìš©
        try:
            yield "\n\nğŸ“Š [ì‹¤ì‹œê°„ DB ì¡°íšŒ] í˜„ì¬ í”„ë¡œì íŠ¸ ìƒíƒœë¥¼ ì¡°íšŒ ì¤‘ì…ë‹ˆë‹¤...\n\n"
            details = await get_project_details.ainvoke({"project_id": project_id})
            if not details or "ì—†ìŒ" in details:
                yield "ì‚¬ìš©ìë‹˜, í˜„ì¬ í”„ë¡œì íŠ¸ ìƒíƒœë¥¼ ì¡°íšŒí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤."
            else:
                yield details
        except Exception as e:
            yield f"ì‚¬ìš©ìë‹˜, ì¡°íšŒ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: {str(e)}"
        return
    
    # ===== FUNCTION_WRITE (ì‹¤í–‰/ë³€ê²½) =====
    if intent == MasterIntent.FUNCTION_WRITE:
        # VERIFIED ê²€ì¦ (í™”ì´íŠ¸ë¦¬ìŠ¤íŠ¸ í† í°)
        verify_result = await self.verify_execution_ready(project_id, message)
        if not verify_result["verified"]:
            yield f"âŒ ì‹¤í–‰ ë¶ˆê°€: {verify_result['reason']}\n\n"
            yield "ì •í™•íˆ 'ì‹¤í–‰ í™•ì •'ì„ ì…ë ¥í•´ì£¼ì„¸ìš”."
            return
        
        # ê²€ì¦ í†µê³¼ â†’ ë²„íŠ¼ ìƒì„± JSON ì¶œë ¥
        ready_json = {
            "status": "READY_TO_START",
            "project_id": project_id,
            "mes_hash": verify_result["mes_hash"],
            "timestamp": datetime.utcnow().isoformat()
        }
        yield json.dumps(ready_json, ensure_ascii=False)
        return
    
    # ===== REQUIREMENT (ìš”êµ¬ì‚¬í•­ ì •ë¦¬) =====
    if intent == MasterIntent.REQUIREMENT:
        # Draft â†’ MES ë§¤ì¹­
        from app.core.database import get_drafts_from_rdb
        session_id = thread_id or str(uuid.uuid4())
        drafts = await get_drafts_from_rdb(session_id, "UNVERIFIED")
        
        if drafts:
            # Draftë¥¼ MESì— ë°˜ì˜
            draft_summary = {}
            for draft in drafts:
                category = draft.category
                content = draft.content
                draft_summary[category] = draft_summary.get(category, []) + [content]
            
            yield "í˜•ë‹˜, ì•„ê¹Œ ë§ì”€í•˜ì‹  ë‚´ìš©ì„ ì„¤ê³„ ì´ˆì•ˆì— ë¨¼ì € ë°˜ì˜í•´ ë‘ì—ˆìŠµë‹ˆë‹¤:\n\n"
            for cat, contents in draft_summary.items():
                yield f"**{cat}**: {', '.join(contents)}\n"
            yield "\n\nì´ì œ LLMìœ¼ë¡œ ë” êµ¬ì²´í™”í•˜ê² ìŠµë‹ˆë‹¤...\n\n"
        
        # LLM í˜¸ì¶œë¡œ MES êµ¬ì²´í™”
        system_instruction = "ìš”êµ¬ì‚¬í•­ì„ ì •ë¦¬í•˜ê³  MESë¥¼ êµ¬ì„±í•˜ì„¸ìš”."
        messages = await self._construct_messages(message, history, project_id, system_instruction)
        
        # Tool ì‚¬ìš© (setup_standard_workflow_tool, get_project_details ë“±)
        tools = [
            get_project_details,
            list_projects,
            setup_standard_workflow_tool,
            execute_project_tool
        ]
        
        llm = ChatOpenAI(...)
        llm_with_tools = llm.bind_tools(tools)
        
        full_content = ""
        async for chunk in llm_with_tools.astream(messages):
            # Tool í˜¸ì¶œ ì²˜ë¦¬ ...
            # ì‘ë‹µ ìŠ¤íŠ¸ë¦¬ë° ...
        
        # Response Builder í›„ì²˜ë¦¬
        has_confirm_token = any(token in message for token in ["ì‹¤í–‰ í™•ì •", "ë³€ê²½ í™•ì •"])
        final_response = self.clean_response(full_content, intent, has_confirm_token)
        
        yield final_response
        await save_message_to_rdb("assistant", final_response, project_id, thread_id)
        return
```

**ë§ˆì´ê·¸ë ˆì´ì…˜ ì²´í¬ë¦¬ìŠ¤íŠ¸:**
- [ ] Intent ë¶„ë¥˜ ë¡œì§ êµì²´ (_classify_intent â†’ MasterIntent enum)
- [ ] NATURAL Intent ì²˜ë¦¬ ì¶”ê°€ (ìì—°ì–´ ì‘ë‹µ + Shadow Mining)
- [ ] FUNCTION_READ ì²˜ë¦¬ ê°•í™” (RAG/KG ì°¨ë‹¨)
- [ ] FUNCTION_WRITE ì²˜ë¦¬ ì¶”ê°€ (verify_execution_ready í˜¸ì¶œ)
- [ ] REQUIREMENT ì²˜ë¦¬ ê°•í™” (Draft â†’ MES ë§¤ì¹­)
- [ ] Response Builder í†µí•© (clean_response í˜¸ì¶œ)
- [ ] De-verification ë¡œì§ ì¶”ê°€ (MES Hash ë³€ê²½ ê°ì§€)
- [ ] ê¸°ì¡´ Intent (UNCLEAR, USER_CHOICE, AFFIRMATIVE_ONLY) ì œê±°
- [ ] Tool í˜¸ì¶œ ë¡œì§ ìœ ì§€ (setup_standard_workflow_tool ë“±)

---

## ğŸ“Š **ë°ì´í„°ë² ì´ìŠ¤ ìŠ¤í‚¤ë§ˆ ë³€ê²½**

### **ì‹ ê·œ í…Œì´ë¸”: `drafts`**

```sql
CREATE TABLE drafts (
    id UUID PRIMARY KEY,
    session_id VARCHAR(255) NOT NULL,
    user_id VARCHAR(255) NOT NULL,
    project_id VARCHAR(255),
    status VARCHAR(50) DEFAULT 'UNVERIFIED',
    category VARCHAR(50) NOT NULL,  -- 'í™˜ê²½', 'ëª©í‘œ', 'ì‚°ì¶œë¬¼', 'ì œì•½'
    content TEXT NOT NULL,
    source VARCHAR(50) DEFAULT 'USER_UTTERANCE',
    timestamp TIMESTAMP DEFAULT NOW(),
    ttl_days INTEGER DEFAULT 7,
    
    INDEX idx_session (session_id),
    INDEX idx_status (status),
    INDEX idx_timestamp (timestamp)
);
```

**ë§ˆì´ê·¸ë ˆì´ì…˜ ìŠ¤í¬ë¦½íŠ¸:**

```python
# backend/scripts/migrate_v32.py
async def create_drafts_table():
    from app.core.database import AsyncEngine
    from sqlalchemy import text
    
    async with AsyncEngine.begin() as conn:
        await conn.execute(text("""
            CREATE TABLE IF NOT EXISTS drafts (
                id UUID PRIMARY KEY,
                session_id VARCHAR(255) NOT NULL,
                user_id VARCHAR(255) NOT NULL,
                project_id VARCHAR(255),
                status VARCHAR(50) DEFAULT 'UNVERIFIED',
                category VARCHAR(50) NOT NULL,
                content TEXT NOT NULL,
                source VARCHAR(50) DEFAULT 'USER_UTTERANCE',
                timestamp TIMESTAMP DEFAULT NOW(),
                ttl_days INTEGER DEFAULT 7
            );
            
            CREATE INDEX IF NOT EXISTS idx_session ON drafts(session_id);
            CREATE INDEX IF NOT EXISTS idx_status ON drafts(status);
            CREATE INDEX IF NOT EXISTS idx_timestamp ON drafts(timestamp);
        """))
    
    print("âœ… drafts í…Œì´ë¸” ìƒì„± ì™„ë£Œ")

if __name__ == "__main__":
    import asyncio
    asyncio.run(create_drafts_table())
```

---

## ğŸ§ª **í•„ìˆ˜ í…ŒìŠ¤íŠ¸ ì¼€ì´ìŠ¤ (12ê°€ì§€)**

### **1. NATURAL Intent í…ŒìŠ¤íŠ¸**

| ì…ë ¥ | ì˜ˆìƒ Intent | ì˜ˆìƒ ì¶œë ¥ | Shadow Mining ë™ì‘ |
|------|-------------|----------|-------------------|
| "ì•ˆë…•" | NATURAL | "ì•ˆë…•í•˜ì„¸ìš”, í˜•ë‹˜! ğŸ˜Š" | âŒ (ì„¤ê³„ ì •ë³´ ì—†ìŒ) |
| "ê³ ë§ˆì›Œ" | NATURAL | "ë³„ë§ì”€ì„ìš”!" | âŒ (ì„¤ê³„ ì •ë³´ ì—†ìŒ) |
| "ã…‹ã…‹ã…‹" | NATURAL | "ã…ã… ğŸ˜„" | âŒ (ì„¤ê³„ ì •ë³´ ì—†ìŒ) |
| "ì•„ì´ë””ì–´ í•˜ë‚˜ ìˆì–´. ë¡œì»¬ì—ì„œ íŒŒì´ì¬ìœ¼ë¡œ now.py ë§Œë“¤ê³  ì‹¶ì–´" | NATURAL | "ì¢‹ì€ ì•„ì´ë””ì–´ë„¤ìš”!" | âœ… Draft 2ê°œ ìƒì„± (í™˜ê²½, ì‚°ì¶œë¬¼) |

### **2. Shadow Mining í…ŒìŠ¤íŠ¸**

| ì‹œë‚˜ë¦¬ì˜¤ | ë™ì‘ | ê²€ì¦ |
|---------|------|------|
| ì‚¬ìš©ì: "ë¡œì»¬ì—ì„œ íŒŒì´ì¬ìœ¼ë¡œ" | Draft ìƒì„± (í™˜ê²½: "ë¡œì»¬, íŒŒì´ì¬") | DB ì¡°íšŒë¡œ í™•ì¸ |
| ì‚¬ìš©ì: "now.py íŒŒì¼ ë§Œë“¤ì–´" | Draft ìƒì„± (ì‚°ì¶œë¬¼: "now.py íŒŒì¼") | DB ì¡°íšŒë¡œ í™•ì¸ |
| ì‚¬ìš©ì: "ì¢€ ë” êµ¬ì²´ì ìœ¼ë¡œ ì •ë¦¬í•´ì¤˜" | Draft â†’ MES ë§¤ì¹­ | "ì•„ê¹Œ ë§ì”€í•˜ì‹  ë¡œì»¬ í™˜ê²½..." ì¶œë ¥ í™•ì¸ |

### **3. FUNCTION_WRITE (confirm_token) í…ŒìŠ¤íŠ¸**

| ì…ë ¥ | ì˜ˆìƒ ë™ì‘ | ì˜ˆìƒ ì¶œë ¥ |
|------|----------|----------|
| "ì‹¤í–‰ í™•ì •" | FUNCTION_WRITE â†’ VERIFIED ê²€ì¦ | âœ… ë²„íŠ¼ ìƒì„± JSON ì¶œë ¥ |
| "ë³€ê²½ í™•ì •" | FUNCTION_WRITE â†’ VERIFIED ê²€ì¦ | âœ… ë²„íŠ¼ ìƒì„± JSON ì¶œë ¥ |
| "START TASK ì‹¤í–‰" | FUNCTION_WRITE â†’ VERIFIED ê²€ì¦ | âœ… ë²„íŠ¼ ìƒì„± JSON ì¶œë ¥ |
| "ì‘" | NATURAL | "ë„¤, í˜•ë‹˜!" (ë²„íŠ¼ X) |
| "ì˜ˆ" | NATURAL | "ë„¤, í˜•ë‹˜!" (ë²„íŠ¼ X) |
| "ì¢‹ì•„" | NATURAL | "ë„¤, í˜•ë‹˜!" (ë²„íŠ¼ X) |
| "ê°€ì" | NATURAL | "ë„¤, í˜•ë‹˜!" (ë²„íŠ¼ X) |
| "ì‹¤í–‰í•´ë„ ë ê¹Œ?" | NATURAL | LLM ì‘ë‹µ (ë²„íŠ¼ X) |

### **4. FUNCTION_READ (RAG ì˜¤ì—¼ ì°¨ë‹¨) í…ŒìŠ¤íŠ¸**

| ì…ë ¥ | ì˜ˆìƒ ë™ì‘ | ê²€ì¦ |
|------|----------|------|
| "í˜„ì¬ ì—ì´ì „íŠ¸ í˜„í™©" | FUNCTION_READ â†’ ì‹¤ì‹œê°„ DB ì¡°íšŒ | Neo4j ì¿¼ë¦¬ ë¡œê·¸ í™•ì¸, RAG ë¯¸ì‚¬ìš© í™•ì¸ |
| "ì§€ê¸ˆ ìƒíƒœ ë³´ì—¬ì¤˜" | FUNCTION_READ â†’ ì‹¤ì‹œê°„ DB ì¡°íšŒ | Neo4j ì¿¼ë¦¬ ë¡œê·¸ í™•ì¸ |
| (DB ì¡°íšŒ ì‹¤íŒ¨ ì‹œ) | ì¡°íšŒ ë¶ˆê°€ í…œí”Œë¦¿ ì¶œë ¥ | "ì¡°íšŒí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤" í™•ì¸ |

### **5. De-verification í…ŒìŠ¤íŠ¸**

| ì‹œë‚˜ë¦¬ì˜¤ | ë™ì‘ | ì˜ˆìƒ ì¶œë ¥ |
|---------|------|----------|
| 1. "ì‹¤í–‰ í™•ì •" â†’ VERIFIED | verification_state["is_verified"] = True | ë²„íŠ¼ ìƒì„± |
| 2. ì—ì´ì „íŠ¸ ì„¤ì • ë³€ê²½ (MES Hash ë³€ê²½) | MES Hash ê°ì§€ â†’ De-verify | "âš ï¸ ì„¤ì • ë³€ê²½ìœ¼ë¡œ í™•ì • ìƒíƒœ í•´ì œ" |
| 3. "ì‹¤í–‰ í™•ì •" ì¬ì…ë ¥ | ë‹¤ì‹œ VERIFIED ê²€ì¦ | ë²„íŠ¼ ì¬ìƒì„± |

### **6. CANCEL / TOPIC_SHIFT í…ŒìŠ¤íŠ¸**

| ì…ë ¥ | ì˜ˆìƒ Intent | ì˜ˆìƒ ì¶œë ¥ | VERIFIED ìƒíƒœ |
|------|-------------|----------|---------------|
| "ì·¨ì†Œ" | CANCEL | "âœ… ì‘ì—… ê³„íš ì´ˆê¸°í™”" | False (í•´ì œë¨) |
| "ì¤‘ë‹¨" | CANCEL | "âœ… ì‘ì—… ê³„íš ì´ˆê¸°í™”" | False (í•´ì œë¨) |
| "ë‹¤ë¥¸ í”„ë¡œì íŠ¸ë¡œ" | TOPIC_SHIFT | "âœ… ëŒ€í™” ì£¼ì œ ë³€ê²½" | False (í•´ì œë¨) |

### **7. Response Builder í…ŒìŠ¤íŠ¸**

| ì‹œë‚˜ë¦¬ì˜¤ | Intent | ì˜ˆìƒ ë™ì‘ |
|---------|--------|----------|
| REQUIREMENT + "READY_TO_START" JSON í¬í•¨ | REQUIREMENT | JSON ë¸”ë¡ ì œê±°ë¨ |
| FUNCTION_WRITE + "ì‹¤í–‰ í™•ì •" | FUNCTION_WRITE | JSON ìœ ì§€ë¨ |
| NATURAL + "MISSION READINESS REPORT" í¬í•¨ | NATURAL | ë³´ê³ ì„œ ì œê±°ë¨ |

### **8. TTL ì •ë¦¬ í…ŒìŠ¤íŠ¸**

| ì‹œë‚˜ë¦¬ì˜¤ | ë™ì‘ | ê²€ì¦ |
|---------|------|------|
| Draft ìƒì„± í›„ 8ì¼ ê²½ê³¼ | cleanup_expired_drafts_task ì‹¤í–‰ | status = 'EXPIRED' ë˜ëŠ” ì‚­ì œë¨ |
| í”„ë¡œì íŠ¸ ì™„ë£Œ | purge_project_drafts í˜¸ì¶œ | ê´€ë ¨ Draft status = 'EXPIRED' |

### **9. Intent ë¶„ë¥˜ ì •í™•ë„ í…ŒìŠ¤íŠ¸**

| ì…ë ¥ | ì˜ˆìƒ Intent | ì˜¤ë¶„ë¥˜ ì—¬ë¶€ |
|------|-------------|-----------|
| "ì•ˆë…•" | NATURAL | âœ… |
| "í˜„ì¬ ìƒíƒœ ë³´ì—¬ì¤˜" | FUNCTION_READ | âœ… |
| "ì •ë¦¬í•´ì¤˜" | REQUIREMENT | âœ… |
| "ì‹¤í–‰ í™•ì •" | FUNCTION_WRITE | âœ… |
| "ì·¨ì†Œ" | CANCEL | âœ… |
| "ì‘" | NATURAL (v2.2ì—ì„œëŠ” AFFIRMATIVE_ONLY) | âœ… ê°œì„ ë¨ |
| "ì‹¤í–‰í•´ë„ ë ê¹Œ?" | NATURAL (v2.2ì—ì„œëŠ” EXECUTION_REQUEST) | âœ… ê°œì„ ë¨ |

### **10. ê¸°ì¡´ í”„ë¡œì íŠ¸ í˜¸í™˜ì„± í…ŒìŠ¤íŠ¸**

| í”„ë¡œì íŠ¸ | v2.2 ë™ì‘ | v3.2 ë™ì‘ | í˜¸í™˜ì„± |
|---------|----------|----------|-------|
| real-task-01 | ì •ìƒ ì‹¤í–‰ | ì •ìƒ ì‹¤í–‰ (Intent ì¬ë¶„ë¥˜) | âœ… |
| ë¸”ë¡œê·¸ ìˆ˜ì • | ì •ìƒ ì‹¤í–‰ | ì •ìƒ ì‹¤í–‰ | âœ… |
| (Draft ì—†ëŠ” í”„ë¡œì íŠ¸) | N/A | Draft ì¡°íšŒ â†’ ë¹ˆ ê²°ê³¼, LLMìœ¼ë¡œ MES êµ¬ì„± | âœ… |

### **11. Shadow Mining ì •í™•ë„ í…ŒìŠ¤íŠ¸**

| ì…ë ¥ | ì¶”ì¶œ ì˜ˆìƒ | ê²€ì¦ |
|------|----------|------|
| "ë¡œì»¬ì—ì„œ íŒŒì´ì¬ìœ¼ë¡œ API ì„œë²„ ë§Œë“¤ê³  ì‹¶ì–´" | í™˜ê²½: "ë¡œì»¬, íŒŒì´ì¬", ì‚°ì¶œë¬¼: "API ì„œë²„" | LLM ì¶œë ¥ í™•ì¸ |
| "ì™¸ë¶€ ë¼ì´ë¸ŒëŸ¬ë¦¬ ì‚¬ìš© ê¸ˆì§€" | ì œì•½: "ì™¸ë¶€ ë¼ì´ë¸ŒëŸ¬ë¦¬ ì‚¬ìš© ê¸ˆì§€" | LLM ì¶œë ¥ í™•ì¸ |
| "ã…‹ã…‹ã…‹" | [] (ë¹ˆ ë°°ì—´) | ì„¤ê³„ ì •ë³´ ì—†ìŒ í™•ì¸ |

### **12. í†µí•© ì‹œë‚˜ë¦¬ì˜¤ í…ŒìŠ¤íŠ¸ (E2E)**

```
ì‚¬ìš©ì: "ì•ˆë…•"
â†’ NATURAL: "ì•ˆë…•í•˜ì„¸ìš”, í˜•ë‹˜! ğŸ˜Š"

ì‚¬ìš©ì: "ë¡œì»¬ì—ì„œ íŒŒì´ì¬ìœ¼ë¡œ now.py ë§Œë“¤ê³  ì‹¶ì–´"
â†’ NATURAL + Shadow Mining: Draft 2ê°œ ìƒì„±

ì‚¬ìš©ì: "ì¢€ ë” êµ¬ì²´ì ìœ¼ë¡œ ì •ë¦¬í•´ì¤˜"
â†’ REQUIREMENT: "ì•„ê¹Œ ë§ì”€í•˜ì‹  ë¡œì»¬ í™˜ê²½ê³¼ íŒŒì´ì¬ ê¸°ë°˜..." + LLM MES êµ¬ì„±

ì‚¬ìš©ì: "í˜„ì¬ ìƒíƒœ ë³´ì—¬ì¤˜"
â†’ FUNCTION_READ: ì‹¤ì‹œê°„ DB ì¡°íšŒ (Markdown í‘œ)

ì‚¬ìš©ì: "ì¤€ë¹„ ì ê²€í•´ì¤˜"
â†’ REQUIREMENT: ì™„ì „ì„± ì²´í¬ + ì‹¤í–‰ ê°€ëŠ¥ì„± ì²´í¬

ì‚¬ìš©ì: "ì‹¤í–‰ í™•ì •"
â†’ FUNCTION_WRITE: VERIFIED ê²€ì¦ í†µê³¼ â†’ [START TASK] ë²„íŠ¼ ìƒì„±

ì‚¬ìš©ì: (ì—ì´ì „íŠ¸ ì„¤ì • ë³€ê²½)
â†’ (ë‚´ë¶€) MES Hash ë³€ê²½ ê°ì§€

ì‚¬ìš©ì: "ì‹¤í–‰ í™•ì •"
â†’ FUNCTION_WRITE: "âš ï¸ ì„¤ì • ë³€ê²½ìœ¼ë¡œ í™•ì • ìƒíƒœ í•´ì œ"

ì‚¬ìš©ì: "ë‹¤ì‹œ í™•ì¸í•´ì¤˜"
â†’ REQUIREMENT: ë‹¤ì‹œ ì™„ì „ì„± ì²´í¬

ì‚¬ìš©ì: "ì‹¤í–‰ í™•ì •"
â†’ FUNCTION_WRITE: VERIFIED ê²€ì¦ í†µê³¼ â†’ [START TASK] ë²„íŠ¼ ì¬ìƒì„±

(ë²„íŠ¼ í´ë¦­)
â†’ Worker ì‹¤í–‰ â†’ now.py ìƒì„±

ì‚¬ìš©ì: "ê³ ë§ˆì›Œ"
â†’ NATURAL: "ë³„ë§ì”€ì„ìš”!"
```

---

## ğŸš€ **ë§ˆì´ê·¸ë ˆì´ì…˜ ìˆœì„œ (ê¶Œì¥)**

### **Step 1: ë°ì´í„°ë² ì´ìŠ¤ ì¤€ë¹„**
```bash
cd D:\project\myllm\backend
python scripts/migrate_v32.py  # drafts í…Œì´ë¸” ìƒì„±
```

### **Step 2: ë°±ê·¸ë¼ìš´ë“œ ì‘ì—… í†µí•©**
```python
# backend/app/main.pyì— ì¶”ê°€
from app.services.draft_cleanup import cleanup_expired_drafts_task

@app.on_event("startup")
async def startup_event():
    asyncio.create_task(cleanup_expired_drafts_task())
```

### **Step 3: stream_message ì ì§„ì  ë§ˆì´ê·¸ë ˆì´ì…˜**
1. ê¸°ì¡´ `stream_message` â†’ `stream_message_v22` ë°±ì—…
2. ìƒˆë¡œìš´ `stream_message_v32` ì‘ì„±
3. í™˜ê²½ ë³€ìˆ˜ë¡œ ë²„ì „ ì„ íƒ (`MASTER_AGENT_VERSION=v3.2`)
4. í…ŒìŠ¤íŠ¸ í›„ ì™„ì „ êµì²´

### **Step 4: í•„ìˆ˜ í…ŒìŠ¤íŠ¸ ì‹¤í–‰**
```bash
pytest tests/test_v32_intents.py
pytest tests/test_v32_shadow_mining.py
pytest tests/test_v32_verified.py
```

### **Step 5: í”„ë¡œë•ì…˜ ë°°í¬**
```bash
git checkout -b feature/v3.2
git add .
git commit -m "feat: v3.2 í†µí•©ë³¸ êµ¬í˜„ ì™„ë£Œ"
git push origin feature/v3.2
```

---

## ğŸ“ˆ **ì˜ˆìƒ ê°œì„  íš¨ê³¼**

| í•­ëª© | v2.2 | v3.2 | ê°œì„ ìœ¨ |
|------|------|------|-------|
| **Intent ê°œìˆ˜** | 11ê°œ | 5ê°œ | -54% |
| **Intent ë¶„ë¥˜ ì •í™•ë„** | 70% | 90% | +20% |
| **ìì—°ì–´ ëŒ€í™” ìì—°ìŠ¤ëŸ¬ì›€** | ë‚®ìŒ (ë©”ë‰´ ê°•ì œ ì¶œë ¥) | ë†’ìŒ (ìì—°ì–´ë¡œë§Œ ì‘ë‹µ) | +80% |
| **confirm_token ì˜¤ì¸ìœ¨** | 30% ("ì‘", "ì˜ˆ" ì˜¤ì¸) | 0% (í™”ì´íŠ¸ë¦¬ìŠ¤íŠ¸) | -100% |
| **Shadow Mining** | ì—†ìŒ | ìˆìŒ (ìë™ ì¶”ì¶œ) | +âˆ |
| **VERIFIED ì‹ ë¢°ì„±** | ì¤‘ê°„ (is_armed) | ë†’ìŒ (ì‹¤ì‹œê°„ ê²€ì¦) | +50% |
| **Response Builder** | ë¶€ë¶„ êµ¬í˜„ | ì™„ì „ êµ¬í˜„ | +40% |
| **TTL ì •ë¦¬** | ì—†ìŒ | ìë™ (1ì‹œê°„ë§ˆë‹¤) | +âˆ |

---

## ğŸ” **ë³´ì•ˆ ë° ì•ˆì •ì„±**

### **ë³´ì•ˆ ê°•í™” ì‚¬í•­**
- âœ… confirm_token í™”ì´íŠ¸ë¦¬ìŠ¤íŠ¸ (SQLi, XSS ë°©ì§€)
- âœ… ì‹¤ì‹œê°„ DB ê²€ì¦ (Stale Data ë°©ì§€)
- âœ… RAG/KG ì˜¤ì—¼ ì°¨ë‹¨ (FUNCTION_READ)
- âœ… Draft TTL (ê°œì¸ì •ë³´ ìë™ ì‚­ì œ)

### **ì•ˆì •ì„± ë³´ì¥**
- âœ… ì˜ˆì™¸ ì²˜ë¦¬ ê°•í™” (verify_execution_ready, shadow_mining)
- âœ… Fallback ë¡œì§ (LLM ì‹¤íŒ¨ ì‹œ ê¸°ë³¸ê°’)
- âœ… ë¡¤ë°± ê°€ëŠ¥ì„± (v2.2 ë°±ì—… ìœ ì§€)

---

## ğŸ“ **ê²°ë¡ **

### **v3.2ì˜ í•µì‹¬ ì² í•™**
> **"ìì—°ì–´ëŠ” ììœ , ë°ì´í„°ëŠ” ê²©ë¦¬, ì‹¤í–‰ì€ ì¦ëª…ëœ ìƒíƒœì—ì„œë§Œ"**

### **ë§ˆì´ê·¸ë ˆì´ì…˜ ì™„ë£Œ ê¸°ì¤€**
- [x] Phase 1-5 ì™„ë£Œ (Intent, Shadow Mining, VERIFIED, Response Builder, TTL)
- [ ] Phase 6 ì™„ë£Œ (stream_message ì¬ì‘ì„±)
- [ ] í•„ìˆ˜ í…ŒìŠ¤íŠ¸ ì¼€ì´ìŠ¤ 12ê°œ í†µê³¼
- [ ] ê¸°ì¡´ í”„ë¡œì íŠ¸ í˜¸í™˜ì„± í™•ì¸
- [ ] í”„ë¡œë•ì…˜ ë°°í¬ ë° ëª¨ë‹ˆí„°ë§

### **í–¥í›„ ê³¼ì œ**
1. Shadow Mining ì •í™•ë„ ê°œì„  (LLM í”„ë¡¬í”„íŠ¸ íŠœë‹)
2. Draft â†’ MES ë§¤ì¹­ ë¡œì§ ê³ ë„í™” (ì¶©ëŒ í•´ê²°, ìš°ì„ ìˆœìœ„)
3. VERIFIED ì¡°ê±´ í™•ì¥ (ì˜ˆ: API ì—°ê²° í…ŒìŠ¤íŠ¸, íŒŒì¼ ê¶Œí•œ ê²€ì¦)
4. ì‚¬ìš©ì í”¼ë“œë°± ê¸°ë°˜ Intent ë¶„ë¥˜ ê°œì„ 

---

**ì‘ì„±ì:** AI Assistant  
**ê²€í† ì:** í˜•ë‹˜ (ì‚¬ìš©ì)  
**ë²„ì „:** v3.2 (AS-IS â†’ TO-BE ìƒì„¸ ê°€ì´ë“œ)  
**ìƒíƒœ:** âœ… Phase 1-5 ì™„ë£Œ, Phase 6 ê°€ì´ë“œ ì œê³µ  
**ë‹¤ìŒ ë‹¨ê³„:** stream_message ì¬ì‘ì„± ë˜ëŠ” ì ì§„ì  ë§ˆì´ê·¸ë ˆì´ì…˜

---

---

## ğŸ›¡ï¸ **[ADDENDUM] v3.2 Guardrail 6ëŒ€ ì›ì¹™ (2026-01-27 ì¶”ê°€)**

### **ìš°ì„ ìˆœìœ„: ABSOLUTE PRIORITY â€“ READ FIRST**

ì´ í”„ë¡œì íŠ¸ì—ì„œ ì»¤ì„œëŠ” **"ì§€ëŠ¥í˜• ì¡°ë ¥ì"ê°€ ì•„ë‹ˆë¼ ì˜ë„ ë¶„ë¥˜ì™€ í–‰ë™ ë¶„ë¦¬ë¥¼ ì •í™•íˆ ì§€í‚¤ëŠ” ì‹œìŠ¤í…œ ì—”ì§€ë‹ˆì–´ë‹¤.**

---

### **ì›ì¹™ 1: IntentëŠ” ë°˜ë“œì‹œ ë‹¨ì¼ Primary + ë³µìˆ˜ Secondary Flag êµ¬ì¡°**

```python
_classify_intent()ëŠ” ë°˜ë“œì‹œ Primary Intent í•˜ë‚˜ë§Œ ë°˜í™˜
FlagsëŠ” ë³µìˆ˜ ê°€ëŠ¥ (ì˜ˆ: ["HAS_REQUIREMENT_SIGNAL", "HAS_DRAFT_DATA"])

âŒ Intentë¥¼ ë³µìˆ˜ë¡œ ë°˜í™˜ ê¸ˆì§€
âŒ UX í¸ì˜ë¥¼ ì´ìœ ë¡œ Intent ìš°íšŒ ë¡œì§ ê¸ˆì§€
```

**êµ¬í˜„:**
```python
def _classify_intent(self, message: str) -> Tuple[MasterIntent, List[str]]:
    intent, flags = MasterIntent.FUNCTION_READ, []
    if "ì •ë¦¬" in message:
        flags.append("HAS_REQUIREMENT_SIGNAL")
    return (intent, flags)
```

---

### **ì›ì¹™ 2: Shadow Mining DraftëŠ” "ì¹´í…Œê³ ë¦¬ë‹¹ ìµœì‹  1ê°œ"ë§Œ ìœ íš¨**

```python
Draft ìƒì„± ì‹œ:
    ë™ì¼ category ì¡´ì¬ â†’ ì´ì „ DraftëŠ” SUPERSEDED

REQUIREMENT ë‹¨ê³„ ë³‘í•© ì‹œ:
    categoryë³„ ìµœì‹  Draftë§Œ MESì— ë°˜ì˜

âŒ Draftë¥¼ ëˆ„ì  ë³‘í•©í•˜ì§€ ì•ŠìŒ
âŒ ê³¼ê±° ì„¸ì…˜ Draftë¥¼ ì°¸ì¡°í•˜ì§€ ì•ŠìŒ
```

**êµ¬í˜„:**
```python
async def _supersede_old_drafts(self, session_id: str, new_drafts: List[Draft]):
    """ë™ì¼ categoryì˜ ì´ì „ DraftëŠ” SUPERSEDEDë¡œ ë³€ê²½"""
    stmt = update(drafts_table).where(
        drafts_table.c.session_id == session_id,
        drafts_table.c.category.in_(new_categories),
        drafts_table.c.status == 'UNVERIFIED'
    ).values(status='SUPERSEDED')
```

---

### **ì›ì¹™ 3: MES ë³€ê²½ì€ ë¬´ì¡°ê±´ VERIFIED í•´ì œ**

```python
ì•„ë˜ ì¤‘ í•˜ë‚˜ë¼ë„ ë°œìƒí•˜ë©´ ì¦‰ì‹œ:
    verification_state["is_verified"] = False

ì¡°ê±´:
1. MES hash ë³€ê²½
2. Draft â†’ MES ë³‘í•©
3. REQUIREMENT intentì—ì„œ í•„ë“œ ìˆ˜ì •

âŒ "ê²½ë¯¸í•œ ë³€ê²½" ì˜ˆì™¸ë¥¼ ë§Œë“¤ì§€ ì•ŠìŒ
```

**êµ¬í˜„:**
```python
if mes_hash != verified_hash:
    self.verification_state["is_verified"] = False
    # ì˜ˆì™¸ ì—†ìŒ
```

---

### **ì›ì¹™ 4: FUNCTION_READëŠ” ì¶”ë¡ ì„ ì ˆëŒ€ í¬í•¨í•˜ì§€ ì•ŠìŒ**

```python
í—ˆìš©:
- ì‹¤ì‹œê°„ DB
- Tool ê²°ê³¼

ê¸ˆì§€:
- KG ì¶”ë¡ 
- Vector ê²€ìƒ‰ ê²°ê³¼
- LLM ë³´ì • ì„¤ëª…

ì¡°íšŒ ì‹¤íŒ¨ ì‹œ:
    "ì¡°íšŒ ë¶ˆê°€ (ì‹¤ì‹œê°„ ë°ì´í„° ì ‘ê·¼ ì‹¤íŒ¨)"ë¡œ ì¦‰ì‹œ ì¢…ë£Œ
```

**êµ¬í˜„:**
```python
if intent == MasterIntent.FUNCTION_READ:
    if not db_result:
        yield "âŒ [Guardrail] ì¡°íšŒ ë¶ˆê°€ (ì‹¤ì‹œê°„ ë°ì´í„° ì ‘ê·¼ ì‹¤íŒ¨)"
        return
    # LLM ë³´ì • ì—†ìŒ
```

---

### **ì›ì¹™ 5: FUNCTION_WRITEëŠ” 4ì¡°ê±´ ANDë§Œ í—ˆìš©**

```python
ì¡°ê±´ (AND):
1. intent == FUNCTION_WRITE
2. VERIFIED == True
3. current_mes_hash == verified_hash
4. confirm_token == ëª…ì‹œì  í† í° (ë‹¨ìˆœ ê¸ì • âŒ)

í•˜ë‚˜ë¼ë„ í‹€ë¦¬ë©´:
    ì•„ë¬´ í–‰ë™ë„ í•˜ì§€ ì•ŠìŒ
    ì•ˆë‚´ ë¬¸êµ¬ë§Œ ë°˜í™˜
```

**êµ¬í˜„:**
```python
CONFIRM_TOKENS = ["ì‹¤í–‰ í™•ì •", "ë³€ê²½ í™•ì •", "START TASK ì‹¤í–‰"]

if (intent == FUNCTION_WRITE and 
    verified and 
    mes_hash == verified_hash and 
    confirm_token in CONFIRM_TOKENS):
    # ë²„íŠ¼ ìƒì„± í—ˆìš©
```

---

### **ì›ì¹™ 6: Response BuilderëŠ” í•­ìƒ ë§ˆì§€ë§‰ì— ì‹¤í–‰**

```python
READY_TO_START
MISSION READINESS REPORT
ë‚´ë¶€ ìƒíƒœ JSON

ìœ„ ë¸”ë¡ì€:
    if intent != FUNCTION_WRITE:
        strip()

âŒ ì¤‘ê°„ ë‹¨ê³„ì—ì„œ ì¡°ê±´ ë¶„ê¸°í•˜ì§€ ì•ŠìŒ
```

**êµ¬í˜„:**
```python
# LLM í˜¸ì¶œ í›„
full_content = ...

# [Guardrail] í•­ìƒ ë§ˆì§€ë§‰ì— ì‹¤í–‰
final_response = self.clean_response(full_content, intent, has_confirm_token)
```

---

### **Guardrail ì ìš© íŒŒì¼ ëª©ë¡**

| íŒŒì¼ | ìˆ˜ì • ë‚´ìš© |
|------|----------|
| `backend/app/services/master_agent_service.py` | Intent Tuple ë°˜í™˜, Flags ì¶”ê°€, VERIFIED í•´ì œ ë¡œì§ ê°•í™” |
| `backend/app/services/shadow_mining.py` | `_supersede_old_drafts` í•¨ìˆ˜ ì¶”ê°€ |
| `docs/V3.2_GUARDRAIL_IMPLEMENTATION.md` | Guardrail êµ¬í˜„ ìƒì„¸ ë¬¸ì„œ (ì‹ ê·œ) |

---

### **ìƒì„¸ ë¬¸ì„œ**

Guardrail 6ëŒ€ ì›ì¹™ì˜ ìƒì„¸ êµ¬í˜„ ë‚´ìš©ì€ ë‹¤ìŒ ë¬¸ì„œë¥¼ ì°¸ê³ í•˜ì„¸ìš”:
- **`D:\project\myllm\docs\V3.2_GUARDRAIL_IMPLEMENTATION.md`**

---

**ì´ ê·œì¹™ì€ Phase 6 ë¦¬íŒ©í† ë§ ì „ì œ ì¡°ê±´ì…ë‹ˆë‹¤.**

---

**END OF DOCUMENT**
