# v3.2.1 Intent 기본값 정책 강화 보고서

**작성일**: 2026-01-27  
**버전**: v3.2.1  
**목적**: LLM 판정 실패 시 무조건 NATURAL로 처리하여 자연스러운 대화 UX 보장

---

## 📋 변경 사항 요약

### 핵심 원칙
**"명시적 키워드가 없으면 모두 NATURAL로 처리한다"**

이 원칙을 통해:
- 긴 인사, 외국어 인사, 모호한 발화에서 시스템이 "멍청하게 굴지 않음"
- 사용자가 자연스럽게 대화할 수 있는 환경 보장
- 시스템 명령과 일상 대화의 명확한 분리

---

## 🔄 AS-IS vs TO-BE 비교

### AS-IS (v3.2 이전)

**문제점:**
- 패턴 매칭 실패 시 불확실한 동작
- "지금", "현재" 같은 일상어가 FUNCTION_READ로 오판될 가능성
- 50자 이상의 긴 인사나 외국어 인사에서 오류 발생 가능성
- LLM 판정 로직 없음

**기존 판정 흐름:**
```
사용자 입력
  ↓
패턴 매칭 (CANCEL, FUNCTION_READ, REQUIREMENT...)
  ↓
매칭 실패 시 → NATURAL (하지만 과정에서 오판 가능)
```

### TO-BE (v3.2.1)

**개선 사항:**
- **명시적 키워드 기반 보수적 판정**
- **기본값 정책 명확화**: 모든 예외는 NATURAL
- **엄격한 패턴 매칭**: 일상어와 시스템 명령 분리

**새로운 판정 흐름:**
```
사용자 입력
  ↓
명시적 CANCEL 토큰? ("취소", "중단", "그만", "abort")
  ↓ NO
명시적 FUNCTION_WRITE 토큰? ("실행 확정", "변경 확정", "START TASK 실행")
  ↓ NO
엄격한 FUNCTION_READ 패턴? ("현재 프로젝트 상태 보여줘")
  ↓ NO
명확한 REQUIREMENT 패턴? ("만들어줘", "수정해줘")
  ↓ NO
명시적 TOPIC_SHIFT 패턴? ("새로 시작해줘")
  ↓ NO
★ NATURAL (기본값 정책) ★
```

---

## 🎯 핵심 변경 사항

### 1. CANCEL Intent (명시적 키워드만)

**AS-IS:**
```python
cancel_tokens = ["취소", "중단", "멈춰", "그만", "하지마", "리셋", "삭제", "abort"]
```

**TO-BE:**
```python
# [v3.2.1] 확실한 취소 신호만 인정
cancel_tokens = ["취소", "중단", "그만", "abort"]
```

**이유:**
- "멈춰", "하지마", "리셋", "삭제"는 일상 대화에서도 사용 가능
- 너무 많은 키워드는 오판 가능성 증가

---

### 2. FUNCTION_READ Intent (엄격한 조합만)

**AS-IS:**
```python
read_patterns = [
    r"(현재|지금|현황).*?(보여줘|알려줘|확인|구성)",  # 너무 광범위
    r"^(현재|지금|현황|등록된|목록|상태|조회)",       # 시작만 체크
]
```

**TO-BE:**
```python
# [v3.2.1] 엄격한 조합만 허용
strict_read_patterns = [
    r"^(현재|지금).*(프로젝트|에이전트|워커|상태|구성|설정).*(보여|알려|확인)",
    r"^(등록된|목록|리스트).*(보여|알려|확인)",
    r"(프로젝트|에이전트|워커).*(상태|현황|목록).*(조회|확인|보여|알려)",
]
```

**이유:**
- "지금 밖에 날씨 어때?" 같은 일상 대화가 FUNCTION_READ로 오판되지 않도록
- 시스템 조회는 반드시 **"시스템 명사(프로젝트, 에이전트) + 조회 동사"** 조합 필수

---

### 3. REQUIREMENT Intent (명확한 작업 요청만)

**AS-IS:**
```python
requirement_patterns = [
    r"(만들어|생성|구현).*?(줘|주세요|해줘|하자)",  # OK
    r"(스케줄러|오류|에러|로그).*?(고쳐|수정|해결)",  # 너무 광범위
]
```

**TO-BE:**
```python
# [v3.2.1] 작업성 발화만 인정
strict_requirement_patterns = [
    r"(만들어|생성|구현|추가|수정|고쳐).*(줘|주세요|해줘|해 주세요)",
    r"(설계|계획|정리|요약).*(해줘|하자|해 주세요)",
    r"프로젝트.*(만들|생성|수정|구현|추가)",
    r"(오류|에러|버그|문제).*(고쳐|수정|해결).*(줘|주세요|해줘)",  # 명령형 필수
]
```

**이유:**
- "아이디어 하나 있어" 같은 브레인스토밍은 NATURAL로 (Flag만 추가)
- 작업 요청은 반드시 **"동사 + 명령형 어미(~줘, ~해줘)"** 조합 필수

---

### 4. 기본값 정책 (v3.2.1 핵심)

**TO-BE 추가:**
```python
# ================================================================
# === [v3.2.1 핵심] 기본값: NATURAL (모든 예외 케이스 처리) ===
# ================================================================
# 위의 명시적 패턴에 매칭되지 않으면 모두 NATURAL로 처리

ctx.set_primary_intent("NATURAL")
ctx.add_log("classify_intent", f"명시적 패턴 미감지 → NATURAL (기본값 정책)")
```

**처리되는 케이스:**
1. **긴 인사**: "부자야 오늘 날씨도 좋은데 고생이 많다"
2. **외국어 인사**: "Hello Buja", "Bonjour", "Hola amigo"
3. **모호한 명령**: "이거 좀 봐봐", "저거 어떻게 됐어?"
4. **단순 감정 표현**: "ㅋㅋㅋ", "오 대박", "와 신기하다"
5. **일상 대화**: "지금 밖에 날씨 어때?", "오늘 뭐 먹을까?"

---

## 📊 UX 변화 비교표

| **사용자 입력** | **AS-IS (v3.2)** | **TO-BE (v3.2.1)** |
|---|---|---|
| "부자야 오늘 날씨도 좋은데 고생이 많다" | ⚠️ 10자 초과로 패턴 매칭 실패 가능성 | ✅ NATURAL로 안전 처리 |
| "Hello Buja" | ⚠️ 키워드 매칭 실패로 오류 가능성 | ✅ NATURAL로 대화 연결 |
| "이거 좀 봐봐" | ⚠️ FUNCTION_READ로 오판 가능성 | ✅ NATURAL로 분류 → "어떤 걸 봐드릴까요?" |
| "지금 밖에 날씨 어때?" | ⚠️ "지금" 키워드로 FUNCTION_READ 오판 | ✅ NATURAL로 자연스러운 대화 |
| "현재 프로젝트 상태 보여줘" | ✅ FUNCTION_READ | ✅ FUNCTION_READ (유지) |
| "실행 확정" | ✅ FUNCTION_WRITE | ✅ FUNCTION_WRITE (유지) |
| "취소" | ✅ CANCEL | ✅ CANCEL (유지) |
| "블로그 만들어줘" | ✅ REQUIREMENT | ✅ REQUIREMENT (유지) |

---

## 🎉 기대 효과

### 1. 자연스러운 대화 UX 보장
- 사용자가 형식에 구애받지 않고 자유롭게 대화 가능
- "멍청한 시스템" 인상 제거

### 2. 오판 최소화
- 일상 대화와 시스템 명령의 명확한 분리
- 명시적 키워드 기반으로 안전성 강화

### 3. Flag 기반 보조 정보 활용
- NATURAL로 분류되더라도 `HAS_BRAINSTORM_SIGNAL`, `HAS_STATUS_SIGNAL` Flag 추가
- LLM이 Flag를 참고하여 더 정확한 응답 생성 가능

### 4. 유지보수성 향상
- 명확한 정책 ("명시적 키워드 없으면 NATURAL")
- 향후 패턴 추가 시 충돌 가능성 감소

---

## 🛠️ 구현 위치

**파일**: `backend/app/services/intent_router.py`  
**함수**: `async def classify_intent(ctx: StreamContext) -> StreamContext`  
**라인**: 114-246

---

## ✅ 검증 체크리스트

| **테스트 케이스** | **예상 Intent** | **검증 여부** |
|---|---|---|
| "안녕" | NATURAL | ⬜ |
| "부자야 오늘 날씨도 좋은데 고생이 많다" | NATURAL | ⬜ |
| "Hello Buja" | NATURAL | ⬜ |
| "이거 좀 봐봐" | NATURAL | ⬜ |
| "지금 밖에 날씨 어때?" | NATURAL | ⬜ |
| "현재 프로젝트 상태 보여줘" | FUNCTION_READ | ⬜ |
| "등록된 에이전트 목록 보여줘" | FUNCTION_READ | ⬜ |
| "블로그 스케줄러 만들어줘" | REQUIREMENT | ⬜ |
| "실행 확정" | FUNCTION_WRITE | ⬜ |
| "취소" | CANCEL | ⬜ |
| "ㅋㅋㅋ 대박" | NATURAL | ⬜ |
| "오 신기하다" | NATURAL | ⬜ |

---

## 📝 향후 개선 방향

### Phase 1: LLM 기반 보조 판정 (선택적)
- 패턴 매칭 실패 시 LLM에게 Intent 추천 요청
- LLM 판정도 실패하면 → NATURAL (기본값 유지)

### Phase 2: 사용자 패턴 학습
- 사용자별 선호 표현 학습 (예: "해줘" vs "해주세요")
- 개인화된 Intent 판정 정확도 향상

### Phase 3: 다국어 지원 강화
- 외국어 인사, 명령어 패턴 확장
- 언어별 Intent 패턴 DB 구축

---

## 🚀 배포 절차

1. **백엔드 재시작**
   ```bash
   cd D:\project\myllm\backend
   python -m uvicorn app.main:app --reload --host 0.0.0.0 --port 8000
   ```

2. **프론트엔드 재시작** (필요 시)
   ```bash
   cd D:\project\myllm\frontend
   npm run dev
   ```

3. **검증**
   - 위의 검증 체크리스트 항목 테스트
   - 로그에서 `"명시적 패턴 미감지 → NATURAL (기본값 정책)"` 메시지 확인

---

## 📌 결론

**v3.2.1 업데이트**는 사용자가 시스템의 형식에 구애받지 않고 자유롭게 대화할 수 있는 환경을 제공합니다.

**핵심 메시지:**
> "명시적 키워드가 없으면 모두 NATURAL로 처리한다"

이를 통해:
- 긴 인사, 외국어 인사, 모호한 발화에서 시스템이 자연스럽게 응대
- 일상 대화와 시스템 명령의 명확한 분리
- 사용자 경험(UX) 품질 향상

---

**문서 버전**: v3.2.1  
**최종 수정일**: 2026-01-27  
**작성자**: MYLLM Development Team
