# 🧪 지식 그래프 백그라운드 축적 테스트

**목적**: 출처 바와 무관하게 지식이 백그라운드에서 계속 쌓이는지 확인

---

## 📋 테스트 시나리오

### **Phase 1: 연속 대화 (출처 확인 안함)**

1. **메시지 1 전송**:
```
데이터베이스 정규화는 중복을 제거하고 무결성을 보장한다
```

2. **메시지 2 전송** (즉시, Worker 대기 안함):
```
인덱스는 쿼리 성능을 향상시키지만 쓰기 성능은 저하시킨다
```

3. **메시지 3 전송** (즉시):
```
트랜잭션은 ACID 속성을 보장해야 한다
```

4. **1분 대기** (Worker가 3개 메시지 모두 처리)

---

### **Phase 2: 백엔드 로그 확인**

**예상 로그** (백엔드 터미널):

```
# 메시지 1 처리
DEBUG: [Batch Extraction] Extracted 3 nodes and 2 relationships
DEBUG: [Batch Neo4j] Node ID mapping created: 3 entries
✅ Relationship created successfully
[info] Batch embeddings saved to Vector DB

# 메시지 2 처리
DEBUG: [Batch Extraction] Extracted 3 nodes and 2 relationships
...

# 메시지 3 처리
DEBUG: [Batch Extraction] Extracted 2 nodes and 1 relationships
...
```

**확인 포인트**:
- [ ] 3개 메시지 모두 처리되었는가?
- [ ] 총 몇 개의 노드가 생성되었는가?
- [ ] 총 몇 개의 관계가 생성되었는가?
- [ ] "Batch embeddings saved to Vector DB" 로그가 3번 나왔는가?

---

### **Phase 3: Neo4j 데이터 확인**

**백엔드 터미널에서 실행**:

```bash
# Neo4j에서 system-master 프로젝트의 노드 개수 확인
# Python 스크립트 또는 직접 쿼리
```

**또는 Graph 탭에서 확인**:
- 브라우저에서 Graph 탭 열기
- 노드 개수 확인 (예: "100 nodes and 2 links")
- 3개 메시지 전송 후 → 노드가 증가했는가?

**예상 결과**:
```
전: 100 nodes
후: 108 nodes (8개 증가: 3+3+2)
```

---

### **Phase 4: RAG 작동 확인**

**메시지 4 전송** (이전 지식 활용):
```
데이터베이스 설계 시 정규화와 인덱스를 어떻게 균형있게 사용해야 하나요?
```

**확인 사항**:
- [ ] AI 응답에 이전 지식이 반영되었는가?
- [ ] 출처 바의 Top Score가 높은가? (0.7 이상)
- [ ] Chunks에 이전 메시지의 내용이 포함되었는가?

**예상 AI 응답**:
```
좋은 질문입니다! 말씀하신 대로 정규화와 인덱스는 서로 트레이드오프 관계입니다.

1. **정규화**: 중복을 제거하고 무결성을 보장합니다 (이전 대화 내용)
2. **인덱스**: 쿼리 성능을 향상시키지만 쓰기 성능은 저하됩니다 (이전 대화 내용)

따라서...
```

---

## ✅ 성공 기준

### **백그라운드 지식 축적**
- [x] 연속 대화 시 모든 메시지가 Worker에서 처리됨
- [x] Neo4j에 노드가 누적됨 (개수 증가)
- [x] Vector DB에 임베딩이 저장됨
- [x] 다음 대화에서 이전 지식이 RAG로 활용됨

### **일반 사용자 시나리오**
- [x] UI에서 출처 바/탭이 안 보임 (권한 없음)
- [x] 하지만 지식은 백그라운드에서 계속 쌓임
- [x] AI 응답에 과거 대화 내용이 반영됨
- [x] 관리자가 Graph 탭에서 누적된 지식 확인 가능

---

## 🐛 문제 발생 시

### **문제 1: Worker 로그가 안 나옴**
- **원인**: Worker가 중단되었거나 오류 발생
- **확인**: 백엔드 터미널에서 `knowledge_worker` 로그 검색
- **해결**: 백엔드 재시작

### **문제 2: Neo4j 노드가 증가하지 않음**
- **원인**: LLM 추출 실패 또는 Neo4j 연결 문제
- **확인**: "Extracted X nodes" 로그 확인
- **해결**: Neo4j 연결 확인, LLM API 키 확인

### **문제 3: RAG에 반영 안됨**
- **원인**: Vector DB 저장 실패 또는 project_id 필터링 문제
- **확인**: "Batch embeddings saved to Vector DB" 로그 확인
- **해결**: Pinecone API 키 확인, project_id 일치 확인

---

## 📊 예상 결과

### **정상 작동 시**

```
메시지 1 → Worker 처리 (5초 후) → 노드 3개 생성
메시지 2 → Worker 처리 (10초 후) → 노드 3개 생성
메시지 3 → Worker 처리 (15초 후) → 노드 2개 생성

총: 8개 노드, 5개 관계 생성

메시지 4 → RAG 검색 → 이전 8개 노드 중 관련 노드 반환 → AI 응답에 반영
```

### **일반 사용자 경험**

1. **사용자**: 연속으로 3개 메시지 전송
2. **UI**: 출처 바 없음, 탭 안 보임
3. **백그라운드**: 지식이 계속 쌓임 (사용자 모름)
4. **사용자**: 나중에 질문
5. **AI**: 이전 대화 내용을 기억하고 답변 (지식 활용)
6. **관리자**: Graph 탭에서 지식 누적 확인 가능

---

**작성일**: 2026-01-30  
**목적**: 백그라운드 지식 축적 기능 검증
