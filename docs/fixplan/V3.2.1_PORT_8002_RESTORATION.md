# v3.2.1 포트 8002번 원복 보고서

**작업일시**: 2026-01-27  
**버전**: v3.2.1  
**원인**: 8000번 포트 충돌 및 백엔드 안정성 문제  
**조치**: 원래 안정적으로 사용하던 8002번 포트로 원복

---

## 🚨 문제 발생 상황

### 증상
- 백엔드가 계속 죽는 현상
- 대화 중 무한 루프처럼 보이는 현상
- 응답 지연 및 불안정

### 원인 분석
```
1. 8000번 포트에 두 개의 프로세스 동시 실행
   - PID 132196 (이전 프로세스, 완전히 종료되지 않음)
   - PID 130300 (새 프로세스)
   
2. 포트 충돌
   - 많은 CLOSE_WAIT 연결 (좀비 커넥션)
   - 서버 자동 리로드 시 이전 프로세스 정리 실패

3. 근본 원인
   - 원래 8002번으로 개발하고 테스트했던 환경
   - 8000번으로 변경 후 설정 파일 일부 누락
   - 포트 변경이 시스템 전체에 일관되게 적용되지 않음
```

---

## ✅ 조치 완료 사항

### 1. 충돌하는 모든 프로세스 종료
```
- PID 132196 (백엔드 - 이전)
- PID 130300 (백엔드 - 새)
- PID 134188 (백엔드 - 최신)
```

### 2. 설정 파일 8002번으로 원복

#### 2-1. 프론트엔드 설정
**파일**: `frontend/src/lib/axios-config.ts`
```typescript
// AS-IS (8000번)
return `http://${hostname}:8000/api/v1`;

// TO-BE (8002번)
return `http://${hostname}:8002/api/v1`;
```

**파일**: `frontend/src/components/chat/ChatInterface.tsx`
```typescript
// AS-IS (8000번)
const baseURL = api.defaults.baseURL || `http://${currentHostname}:8000/api/v1`;

// TO-BE (8002번)
const baseURL = api.defaults.baseURL || `http://${currentHostname}:8002/api/v1`;
```

#### 2-2. 워커 설정
**파일**: `local_agent_hub/agents.yaml`
```yaml
# AS-IS (8000번)
server:
  url: http://127.0.0.1:8000

# TO-BE (8002번)
server:
  url: http://127.0.0.1:8002
```

#### 2-3. 환경 변수 (참고)
**파일**: `frontend/.env.local` (gitignore)
```bash
# TO-BE (8002번)
NEXT_PUBLIC_API_URL=http://localhost:8002
```

### 3. 전체 시스템 재시작

#### 백엔드
```bash
cd D:\project\myllm\backend
python -m uvicorn app.main:app --reload --host 0.0.0.0 --port 8002
```
- ✅ PID: 130516
- ✅ 포트: 8002
- ✅ 상태: 정상 실행 중

#### 워커
```bash
cd D:\project\myllm\local_agent_hub
python main.py
```
- ✅ Worker ID: worker_001
- ✅ 서버 연결: http://127.0.0.1:8002
- ✅ Heartbeat: 정상

#### 프론트엔드
```bash
cd D:\project\myllm\frontend
npm run dev
```
- ✅ 포트: 3000
- ✅ 백엔드 연결: http://127.0.0.1:8002
- ✅ 상태: 정상 실행 중

---

## 📊 시스템 상태 (현재)

### 전체 아키텍처
```
프론트엔드 (localhost:3000)
    ↓
백엔드 (0.0.0.0:8002)
    ↓
워커 (127.0.0.1:8002 연결)
```

### 프로세스 상태
| **컴포넌트** | **PID** | **포트** | **상태** |
|---|---|---|---|
| 백엔드 | 130516 | 8002 | ✅ 정상 |
| 워커 | - | - | ✅ 정상 (Heartbeat OK) |
| 프론트엔드 | - | 3000 | ✅ 정상 |

### 로그 위치
- **백엔드**: `c:\Users\PC\.cursor\projects\d-project-myllm\terminals\21.txt`
- **워커**: `c:\Users\PC\.cursor\projects\d-project-myllm\terminals\22.txt`
- **프론트엔드**: `c:\Users\PC\.cursor\projects\d-project-myllm\terminals\23.txt`

---

## 🎯 v3.2.1 Intent 정책 유지

**중요**: 포트만 8002번으로 원복되었으며, v3.2.1의 Intent 분류 로직은 그대로 유지됩니다.

### v3.2.1 핵심 정책
> "명시적 키워드가 없으면 모두 NATURAL로 처리한다"

### 기대 효과 (변경 없음)
```
✅ "안녕" → NATURAL
✅ "Hello Buja" → NATURAL
✅ "지금 밖에 날씨 어때?" → NATURAL
✅ "부자야 오늘 날씨도 좋은데 고생이 많다" → NATURAL
✅ "현재 프로젝트 상태 보여줘" → FUNCTION_READ
✅ "블로그 만들어줘" → REQUIREMENT
✅ "실행 확정" → FUNCTION_WRITE
✅ "취소" → CANCEL
```

---

## 🧪 테스트 가이드

### 1. 브라우저 캐시 삭제
**중요**: 포트 변경으로 인해 브라우저 캐시를 삭제해야 합니다.
- Chrome/Edge: `Ctrl + Shift + Delete` → 캐시 삭제
- 또는 시크릿/InPrivate 모드로 테스트

### 2. 접속 URL
```
http://localhost:3000
```

### 3. 테스트 케이스
위의 v3.2.1 검증 체크리스트와 동일합니다.

---

## 📝 교훈 및 권장 사항

### 1. 포트 변경 시 주의사항
포트를 변경할 때는 다음 파일들을 **모두** 수정해야 합니다:
- `frontend/src/lib/axios-config.ts`
- `frontend/src/components/chat/ChatInterface.tsx`
- `local_agent_hub/agents.yaml`
- `frontend/.env.local` (gitignore)

### 2. 프로세스 정리
서버 재시작 시 이전 프로세스가 완전히 종료되었는지 확인:
```powershell
netstat -ano | findstr :[PORT_NUMBER]
```

### 3. 안정성 우선
- 이미 안정적으로 작동하던 설정(8002번)을 유지하는 것이 좋습니다
- 포트 변경은 충분한 테스트 후에 진행해야 합니다

### 4. 향후 포트 변경 시
만약 다시 8000번(또는 다른 포트)으로 변경하려면:
1. 모든 프로세스 종료 확인
2. 위의 모든 설정 파일 일괄 변경
3. 브라우저 캐시 삭제 안내
4. 충분한 안정성 테스트

---

## ✅ 최종 확인 사항

### 시스템 상태
- ✅ 백엔드: 8002번 포트에서 정상 실행 중
- ✅ 워커: 8002번 포트로 정상 연결됨
- ✅ 프론트엔드: 3000번 포트에서 정상 실행 중
- ✅ v3.2.1 Intent 정책: 정상 적용됨
- ✅ 포트 충돌: 해결됨

### 안정성 지표
- 이전 프로세스 완전 종료됨
- 새 프로세스들 간 충돌 없음
- Heartbeat 정상 (워커 ↔ 백엔드)
- CLOSE_WAIT 연결 정리됨

---

## 🎉 결론

**시스템이 원래의 안정적인 8002번 포트로 원복되었습니다.**

이제:
- ✅ 백엔드가 안정적으로 실행됩니다
- ✅ 대화가 정상적으로 작동합니다
- ✅ v3.2.1 Intent 정책이 적용되어 자연스러운 대화가 가능합니다

**브라우저 캐시를 삭제하신 후 http://localhost:3000 에서 테스트해보세요!** 😊

---

**문서 버전**: v3.2.1  
**최종 수정일**: 2026-01-27 (포트 8002 원복 완료)  
**작성자**: MYLLM Development Team
