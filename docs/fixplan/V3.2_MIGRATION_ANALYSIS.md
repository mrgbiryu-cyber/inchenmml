# ğŸ”„ v2.2 â†’ v3.2 ë§ˆì´ê·¸ë ˆì´ì…˜ ë¶„ì„

**ë¶„ì„ ì¼ì‹œ:** 2026-01-27  
**í˜„ì¬ ìƒíƒœ:** v2.2 (Cursor Directive Integration + ë°©ì–´ ì²´ê³„)  
**ëª©í‘œ ìƒíƒœ:** v3.2 (ìì—°ì–´ ììœ ë„ + ê°•ì œ ê²Œì´íŠ¸ + Shadow Mining)

---

## ğŸ“‹ **êµ¬í˜„ ìƒíƒœ ë§¤íŠ¸ë¦­ìŠ¤**

| í•­ëª© | v2.2 í˜„ì¬ êµ¬í˜„ | v3.2 ìš”êµ¬ì‚¬í•­ | ìƒíƒœ | ë‚œì´ë„ |
|------|---------------|--------------|------|-------|
| **0. ì—­í•  ë¶„ë¦¬** | ë¶€ë¶„ êµ¬í˜„ (MASTER + Worker) | MASTER/EXECUTOR/STATUS_QUERY 3-tier | ğŸŸ¡ ë³´ê°• í•„ìš” | â­â­ |
| **1. ì¸í…íŠ¸ ë¶„ë¥˜** | 11ê°€ì§€ ë¶„ë¥˜ (EXECUTION_REQUEST, STATUS_QUERY ë“±) | 5ê°€ì§€ ë¶„ë¥˜ (NATURAL, REQUIREMENT, FUNCTION_READ/WRITE, CANCEL) | ğŸ”´ ì¬ì„¤ê³„ í•„ìš” | â­â­â­â­ |
| **2. ì¸í…íŠ¸ íŒì •** | LLM íŒë‹¨ + í‚¤ì›Œë“œ ë§¤ì¹­ (í˜¼ì¬) | ì „ìš© í•¨ìˆ˜ ë¶„ë¦¬ + ì •ê·œì‹ ìš°ì„  | ğŸŸ¢ ê±°ì˜ ì™„ì„± | â­â­ |
| **3. Shadow Mining** | âŒ ë¯¸êµ¬í˜„ | Draft ì‹œìŠ¤í…œ (UNVERIFIED ìƒíƒœ) | ğŸ”´ ì‹ ê·œ êµ¬ì¶• í•„ìš” | â­â­â­â­â­ |
| **4. REQUIREMENT ë‹¨ê³„** | ë¶€ë¶„ êµ¬í˜„ (LLMì´ ì§ì ‘ ì²˜ë¦¬) | Draft â†’ MES ë§¤ì¹­ ìë™í™” | ğŸŸ¡ ë³´ê°• í•„ìš” | â­â­â­ |
| **5. VERIFIED ê·œì¹™** | ARMED ìƒíƒœ (MES Hash ê¸°ë°˜) | VERIFIED (ì‹¤ì‹œê°„ DB + confirm_token) | ğŸŸ¡ ê°•í™” í•„ìš” | â­â­â­ |
| **6. FUNCTION Read/Write ë¶„ë¦¬** | STATUS_QUERYì™€ ê¸°íƒ€ ë¶„ë¦¬ | FUNCTION_READ/WRITE ëª…í™•í•œ ë¶„ë¦¬ | ğŸŸ¡ ë³´ê°• í•„ìš” | â­â­ |
| **7. De-arming ê·œì¹™** | âœ… êµ¬í˜„ ì™„ë£Œ (MES Hash ë³€ê²½ ê°ì§€) | ë™ì¼ | ğŸŸ¢ ì™„ë£Œ | â­ |
| **8. MES Hash ì •ê·œí™”** | âœ… êµ¬í˜„ ì™„ë£Œ (SHA256) | Key ì •ë ¬ + ê³µë°± ì •ê·œí™” ì¶”ê°€ | ğŸŸ¢ ê±°ì˜ ì™„ì„± | â­ |
| **9. RAG ì˜¤ì—¼ ì°¨ë‹¨** | âœ… STATUS_QUERYì—ë§Œ êµ¬í˜„ | FUNCTION_READ ì „ì²´ë¡œ í™•ì¥ | ğŸŸ¡ ë³´ê°• í•„ìš” | â­â­ |
| **10. Response Builder í›„ì²˜ë¦¬** | ë¶€ë¶„ êµ¬í˜„ (re.subë¡œ ì œê±°) | ì¡°ê±´ë¶€ ë¸”ë¡ ì œê±° ê°•í™” | ğŸŸ¡ ë³´ê°• í•„ìš” | â­â­ |
| **11. TTL ë° ì •ë¦¬ ì •ì±…** | âŒ ë¯¸êµ¬í˜„ | Draft TTL (7ì¼) + purge | ğŸ”´ ì‹ ê·œ êµ¬ì¶• í•„ìš” | â­â­â­ |
| **12. í…ŒìŠ¤íŠ¸ ì¼€ì´ìŠ¤** | ë¶€ë¶„ í†µê³¼ | 6ê°€ì§€ í•„ìˆ˜ ì¼€ì´ìŠ¤ | ğŸŸ¡ ê²€ì¦ í•„ìš” | â­â­ |

**ë²”ë¡€:**
- ğŸŸ¢ ì™„ë£Œ (80% ì´ìƒ êµ¬í˜„)
- ğŸŸ¡ ë³´ê°• í•„ìš” (50-80% êµ¬í˜„)
- ğŸ”´ ì‹ ê·œ êµ¬ì¶• í•„ìš” (50% ë¯¸ë§Œ)

---

## ğŸ¯ **í•µì‹¬ ì°¨ì´ì  (v2.2 â†’ v3.2)**

### **1. ì¸í…íŠ¸ ì²´ê³„ ëŒ€ë³€í˜**

#### **v2.2 (í˜„ì¬)**
```python
# 11ê°€ì§€ ì¸í…íŠ¸ (master_agent_service.py)
EXECUTION_REQUEST      # ì‹¤í–‰ ìš”ì²­
STATUS_QUERY          # ìƒíƒœ ì¡°íšŒ
CONFIG_CHANGE         # ì„¤ì • ë³€ê²½
READINESS_CHECK       # ì¤€ë¹„ ìƒíƒœ ì ê²€
CANCEL               # ì·¨ì†Œ
TOPIC_SHIFT          # ì£¼ì œ ë³€ê²½
MES_BUILD            # ìš”êµ¬ì‚¬í•­ ì •ë¦¬
AFFIRMATIVE_ONLY     # ë‹¨ìˆœ ê¸ì •
UNCLEAR              # ì• ë§¤í•œ ì…ë ¥
USER_CHOICE          # ìˆ«ì ì„ íƒ
(default)            # ìì—°ì–´ ëŒ€í™”
```

#### **v3.2 (ìš”êµ¬ì‚¬í•­)**
```python
# 5ê°€ì§€ ì¸í…íŠ¸ (ë‹¨ìˆœí™” + ëª…í™•í™”)
NATURAL              # ìì—°ì–´ ëŒ€í™” (ì¡ë‹´, ê°ì‚¬ ë“±)
REQUIREMENT          # ìš”êµ¬ì‚¬í•­ ì •ë¦¬ (MES ë¹Œë“œ)
FUNCTION_READ        # ì¡°íšŒ ì „ìš© (í˜„í™©, ëª©ë¡, ìƒíƒœ)
FUNCTION_WRITE       # ì‹¤í–‰/ë³€ê²½ (DB Write, ë²„íŠ¼ ìƒì„±)
CANCEL / TOPIC_SHIFT # ì·¨ì†Œ ë° ì£¼ì œ ë³€ê²½
```

**ë§ˆì´ê·¸ë ˆì´ì…˜ ë§µí•‘:**
- `STATUS_QUERY` â†’ `FUNCTION_READ`
- `EXECUTION_REQUEST` + `CONFIG_CHANGE` â†’ `FUNCTION_WRITE`
- `READINESS_CHECK` â†’ `FUNCTION_READ` (ì¼ë¶€ëŠ” `FUNCTION_WRITE` ì „ë‹¨ê³„)
- `MES_BUILD` â†’ `REQUIREMENT`
- `AFFIRMATIVE_ONLY` + `(default)` â†’ `NATURAL`
- `UNCLEAR`, `USER_CHOICE` â†’ **íê¸°** (ì„ íƒì§€ ë©”ë‰´ ì‹œìŠ¤í…œ ì œê±°)

---

### **2. Shadow Mining (ê°€ì¥ í° ì‹ ê·œ ê¸°ëŠ¥)**

#### **ê°œë…**
- ì‚¬ìš©ìê°€ ìì—°ì–´ë¡œ "ì•„ì´ë””ì–´ í•˜ë‚˜ ìˆì–´", "ë¡œì»¬ì—ì„œ ëŒë¦¬ê³  ì‹¶ì–´" ë“±ì„ ë§í•  ë•Œ
- ì¦‰ì‹œ MESë¥¼ ë¬»ì§€ ì•Šê³ , **Draft(ì„ì‹œ ë©”ëª¨)**ë¡œ ì €ì¥
- ë‚˜ì¤‘ì— `REQUIREMENT` ì¸í…íŠ¸ ì§„ì… ì‹œ Draftë¥¼ ìë™ìœ¼ë¡œ MESì— ë°˜ì˜

#### **ì˜ˆì‹œ ì‹œë‚˜ë¦¬ì˜¤**
```
ì‚¬ìš©ì: "ì•ˆë…•"
MASTER: "ì•ˆë…•í•˜ì„¸ìš”, í˜•ë‹˜!" [NATURAL]

ì‚¬ìš©ì: "ì•„ì´ë””ì–´ í•˜ë‚˜ ìˆì–´. ë¡œì»¬ì—ì„œ íŒŒì´ì¬ìœ¼ë¡œ now.py ë§Œë“¤ê³  ì‹¶ì–´"
MASTER: "ì¢‹ì€ ì•„ì´ë””ì–´ë„¤ìš”!" [NATURAL + Shadow Mining]
[ë‚´ë¶€ ë™ì‘]
â†’ Draft ìƒì„±:
  {
    "status": "UNVERIFIED",
    "session_id": "abc123",
    "source": "USER_UTTERANCE",
    "category": "í™˜ê²½",
    "content": "ë¡œì»¬, íŒŒì´ì¬"
  }
  {
    "category": "ì‚°ì¶œë¬¼",
    "content": "now.py íŒŒì¼"
  }

ì‚¬ìš©ì: "ì¢€ ë” êµ¬ì²´ì ìœ¼ë¡œ ì •ë¦¬í•´ì¤˜"
MASTER: "í˜•ë‹˜, ì•„ê¹Œ ë§ì”€í•˜ì‹  ë¡œì»¬ í™˜ê²½ê³¼ íŒŒì´ì¬ ê¸°ë°˜ ë‚´ìš©ì„ ì„¤ê³„ ì´ˆì•ˆì— ë¨¼ì € ë°˜ì˜í•´ ë‘ì—ˆìŠµë‹ˆë‹¤." [REQUIREMENT]
[ë‚´ë¶€ ë™ì‘]
â†’ Draft â†’ MES ë§¤ì¹­:
  MES = {
    "environment": "ë¡œì»¬, íŒŒì´ì¬",
    "deliverable": "now.py íŒŒì¼",
    "objective": "í˜„ì¬ ì‹œê°„ ì¶œë ¥",
    ...
  }
```

#### **êµ¬í˜„ í•„ìš” ì‚¬í•­**
1. **Draft ì €ì¥ì†Œ (Neo4j or PostgreSQL)**
   - Schema: `Draft(id, session_id, status, category, content, timestamp, ttl)`
   - Index: `session_id`, `status`, `timestamp`

2. **Shadow Mining ì—”ì§„**
   - `extract_design_info(user_input) -> List[Draft]`
   - LLM í˜¸ì¶œë¡œ ì„¤ê³„ ì •ë³´ ì¶”ì¶œ (í™˜ê²½, ëª©í‘œ, ì‚°ì¶œë¬¼, ì œì•½)

3. **Draft â†’ MES ë§¤ì¹­ ë¡œì§**
   - `merge_drafts_to_mes(session_id) -> MES`
   - Draft ìš°ì„ ìˆœìœ„: ìµœì‹  > ì´ì „, ëª…ì‹œì  > ì•”ì‹œì 

---

### **3. VERIFIED ì‹œìŠ¤í…œ (ARMEDì˜ ê°•í™”íŒ)**

#### **v2.2 ARMED (í˜„ì¬)**
```python
# master_agent_service.py
self.is_armed = True  # ë‹¨ìˆœ boolean
self.armed_mes_hash = "abc123..."  # MES Hash ì €ì¥
```

**ë¬¸ì œì :**
- `is_armed`ê°€ `True`ì—¬ë„ ì‹¤ì œë¡œ DBì—ì„œ ë°ì´í„°ë¥¼ ë‹¤ì‹œ ì½ì§€ ì•ŠìŒ
- LLMì´ "READY_TO_START" JSONì„ ì¶œë ¥í•˜ë©´ ë²„íŠ¼ ìƒì„± (ì—„ê²©í•˜ì§€ ì•ŠìŒ)

#### **v3.2 VERIFIED (ìš”êµ¬ì‚¬í•­)**
```python
# ì¡°ê±´ (AND):
1. intent == FUNCTION_WRITE
2. ì‹¤ì‹œê°„ DB/Tool í˜¸ì¶œ ì„±ê³µ
3. ê²°ê³¼ê°€ ë¹ˆ ê°’ì´ ì•„ë‹˜
4. confirm_token == "ì‹¤í–‰ í™•ì •" / "ë³€ê²½ í™•ì •" / "START TASK ì‹¤í–‰"

# ì˜ì‚¬ ì½”ë“œ
if intent == "FUNCTION_WRITE":
    if not verify_realtime_db_call():
        return "ì¡°íšŒ ë¶ˆê°€"
    
    if confirm_token not in ["ì‹¤í–‰ í™•ì •", "ë³€ê²½ í™•ì •", "START TASK ì‹¤í–‰"]:
        return "í™•ì • í† í°ì´ ì—†ìŠµë‹ˆë‹¤. 'ì‹¤í–‰ í™•ì •'ì„ ì…ë ¥í•´ì£¼ì„¸ìš”."
    
    # ì´ì œì•¼ ë²„íŠ¼ ìƒì„± ë° DB Write í—ˆìš©
    return generate_start_button()
```

**ì°¨ì´ì :**
- ARMED: "ì¤€ë¹„ë¨" ìƒíƒœ (ì†Œê·¹ì )
- VERIFIED: "ì¦ëª…ë¨" ìƒíƒœ (ì ê·¹ì , ì‹¤ì‹œê°„ ê²€ì¦ í•„ìˆ˜)

---

### **4. confirm_token ì—„ê²©í™”**

#### **v2.2 (í˜„ì¬)**
```python
# _classify_intentì—ì„œ "ì‹¤í–‰" í‚¤ì›Œë“œë§Œ ì²´í¬
if any(k in message for k in ["ì‹¤í–‰", "ì‹œì‘", "ëŒë ¤", "ì§„í–‰"]):
    return ("EXECUTION_REQUEST", [...])
```

**ë¬¸ì œì :**
- "ì‹¤í–‰í•´ë„ ë ê¹Œ?", "ì‹¤í–‰ ê°€ëŠ¥í•´?" ê°™ì€ ì§ˆë¬¸ë„ `EXECUTION_REQUEST`ë¡œ ë¶„ë¥˜
- "ì‘", "ì˜ˆ", "ì¢‹ì•„" ê°™ì€ ë‹¨ìˆœ ê¸ì •ë„ ì‹¤í–‰ìœ¼ë¡œ ì˜¤ì¸ ê°€ëŠ¥

#### **v3.2 (ìš”êµ¬ì‚¬í•­)**
```python
# ì—„ê²©í•œ í† í° ë§¤ì¹­
CONFIRM_TOKENS = ["ì‹¤í–‰ í™•ì •", "ë³€ê²½ í™•ì •", "START TASK ì‹¤í–‰"]

if intent == "FUNCTION_WRITE":
    if not any(token in user_input for token in CONFIRM_TOKENS):
        return "í™•ì • í† í°ì´ ì—†ìŠµë‹ˆë‹¤. ì •í™•íˆ 'ì‹¤í–‰ í™•ì •'ì„ ì…ë ¥í•´ì£¼ì„¸ìš”."
```

**ì°¨ì´ì :**
- v2.2: ëŠìŠ¨í•œ í‚¤ì›Œë“œ ë§¤ì¹­
- v3.2: ì •í™•í•œ í† í° ë§¤ì¹­ (whitelist ë°©ì‹)

---

### **5. Response Builder í›„ì²˜ë¦¬ ê°•í™”**

#### **v2.2 (í˜„ì¬)**
```python
# master_agent_service.py (stream_message ëë¶€ë¶„)
# [RULE 5] Response Builder - ë¶ˆí•„ìš”í•œ ìë™ ë¶€ì°© ì œê±°
full_content = re.sub(r"---\s*MISSION READINESS REPORT\s*---[\s\S]*$", "", full_content)
full_content = re.sub(r'```json\s*\{\s*"status"\s*:\s*"READY_TO_START"[\s\S]*?```', "", full_content)
```

**ë¬¸ì œì :**
- `READINESS_CHECK` Intentê°€ ì•„ë‹ ë•Œë§Œ ì œê±°
- LLMì´ ë‹¤ë¥¸ í˜•íƒœë¡œ ì¶œë ¥í•˜ë©´ ì œê±° ì‹¤íŒ¨

#### **v3.2 (ìš”êµ¬ì‚¬í•­)**
```python
# ì¡°ê±´: intent != FUNCTION_WRITE OR confirm_token ë¯¸ì¡´ì¬
def clean_response(content, intent, has_confirm_token):
    if intent != "FUNCTION_WRITE" or not has_confirm_token:
        # ëª¨ë“  ìë™ ìƒì„± ë¸”ë¡ ì œê±°
        content = remove_mission_readiness(content)
        content = remove_ready_to_start_json(content)
        content = remove_setup_guide(content)
    return content
```

---

### **6. NATURAL Intent ì²˜ë¦¬ (ê°€ì¥ ì¤‘ìš”í•œ UX ê°œì„ )**

#### **v2.2 (í˜„ì¬)**
```
ì‚¬ìš©ì: "ì•ˆë…•"
MASTER: "ì•ˆë…•í•˜ì„¸ìš”, í˜•ë‹˜. ë‹¤ìŒ ì¤‘ ì–´ë–¤ ì‘ì—…ì„ ì›í•˜ì‹œë‚˜ìš”?
1. ğŸ“Š í˜„ì¬ í”„ë¡œì íŠ¸ ìƒíƒœ ì¡°íšŒ
2. âš™ï¸ ì—ì´ì „íŠ¸ ì„¤ì • ë³€ê²½
..."
```

**ë¬¸ì œì :**
- ìì—°ìŠ¤ëŸ¬ìš´ ì¡ë‹´ì—ë„ ë©”ë‰´ê°€ ëœ¸
- ì‚¬ìš©ì ê²½í—˜ ì €í•˜

#### **v3.2 (ìš”êµ¬ì‚¬í•­)**
```
ì‚¬ìš©ì: "ì•ˆë…•"
MASTER: "ì•ˆë…•í•˜ì„¸ìš”, í˜•ë‹˜!" [ë]

ì‚¬ìš©ì: "ê³ ë§ˆì›Œ"
MASTER: "ë³„ë§ì”€ì„ìš”! ğŸ˜Š" [ë]

ì‚¬ìš©ì: "ì•„ì´ë””ì–´ í•˜ë‚˜ ìˆì–´"
MASTER: "ì¢‹ì€ ì•„ì´ë””ì–´ë„¤ìš”! ë§ì”€í•´ì£¼ì„¸ìš”." [Shadow Mining í™œì„±í™”]
```

**ì°¨ì´ì :**
- v2.2: ëª¨ë“  ì…ë ¥ì— ê¸°ëŠ¥ ì œê³µ ì‹œë„ (ì ê·¹ì )
- v3.2: ìì—°ì–´ëŠ” ìì—°ì–´ë¡œë§Œ ì‘ë‹µ (ì†Œê·¹ì , ì¸ê°„ì )

---

## ğŸ› ï¸ **ë§ˆì´ê·¸ë ˆì´ì…˜ ì „ëµ**

### **Phase 1: ì¸í…íŠ¸ ì²´ê³„ ì¬ì„¤ê³„ (ê°€ì¥ ì‹œê¸‰)**

#### **1-1. ì¸í…íŠ¸ enum ì •ì˜**
```python
# backend/app/models/master.py
from enum import Enum

class MasterIntent(str, Enum):
    NATURAL = "NATURAL"
    REQUIREMENT = "REQUIREMENT"
    FUNCTION_READ = "FUNCTION_READ"
    FUNCTION_WRITE = "FUNCTION_WRITE"
    CANCEL = "CANCEL"
    TOPIC_SHIFT = "TOPIC_SHIFT"
```

#### **1-2. _classify_intent í•¨ìˆ˜ ì¬ì‘ì„±**
```python
# backend/app/services/master_agent_service.py
def _classify_intent(self, message: str) -> MasterIntent:
    """v3.2 ì¸í…íŠ¸ ë¶„ë¥˜ (ì •ê·œì‹ ìš°ì„ , LLM ë³´ì¡°)"""
    msg = message.strip()
    
    # 1. NATURAL (ìµœìš°ì„  - ì¡ë‹´ ê°ì§€)
    if re.search(r"^(ì•ˆë…•|í•˜ì´|ã…ã…‡|ê³ ë§ˆì›Œ|ã…‹ã…‹|ã„³|ã…‡ã…‹|êµ¿|ì¢‹ì•„|ì˜¤|ì•„|ì–´|ìŒ)$", msg):
        return MasterIntent.NATURAL
    
    # 2. CANCEL / TOPIC_SHIFT
    if re.search(r"(ì·¨ì†Œ|ì¤‘ë‹¨|ë©ˆì¶°|ê·¸ë§Œ|ì•„ë‹ˆì•¼)", msg):
        return MasterIntent.CANCEL
    if re.search(r"(ë‹¤ë¥¸|ë°”ê¿”|ìƒˆë¡œìš´|ì²˜ìŒë¶€í„°)", msg):
        return MasterIntent.TOPIC_SHIFT
    
    # 3. FUNCTION_WRITE (ì—„ê²©í•œ í† í° ë§¤ì¹­)
    confirm_tokens = ["ì‹¤í–‰ í™•ì •", "ë³€ê²½ í™•ì •", "START TASK ì‹¤í–‰"]
    if any(token in msg for token in confirm_tokens):
        return MasterIntent.FUNCTION_WRITE
    
    # 4. FUNCTION_READ (ëª…í™•í•œ ì¡°íšŒ ì˜ë„)
    if re.search(r"(í˜„ì¬|ì§€ê¸ˆ|í˜„í™©|ë“±ë¡ëœ|ëª©ë¡|ìƒíƒœ|ë³´ì—¬ì¤˜|ì•Œë ¤ì¤˜|í™•ì¸|ì¡°íšŒ)", msg):
        return MasterIntent.FUNCTION_READ
    
    # 5. REQUIREMENT (ëª…ì‹œì  ìš”ì²­)
    if re.search(r"(ì •ë¦¬|ìš”ì•½|êµ¬ì²´í™”|ì„¤ê³„|ê³„íš|ë§Œë“¤ì–´|ìƒì„±|ì¶”ê°€)", msg):
        return MasterIntent.REQUIREMENT
    
    # 6. LLM íŒë‹¨ (ì• ë§¤í•œ ê²½ìš°ë§Œ)
    return self._llm_classify_intent(msg)
```

#### **ë‚œì´ë„:** â­â­â­ (3/5)
#### **ì˜ˆìƒ ì‹œê°„:** 1-2ì‹œê°„
#### **ë¦¬ìŠ¤í¬:** ğŸŸ¡ ì¤‘ê°„ (ê¸°ì¡´ ë¡œì§ ëŒ€í­ ë³€ê²½, í…ŒìŠ¤íŠ¸ í•„ìˆ˜)

---

### **Phase 2: Shadow Mining ì‹œìŠ¤í…œ êµ¬ì¶•**

#### **2-1. Draft ëª¨ë¸ ì •ì˜**
```python
# backend/app/models/draft.py
from pydantic import BaseModel
from datetime import datetime

class Draft(BaseModel):
    id: str
    session_id: str
    user_id: str
    project_id: Optional[str]
    status: str = "UNVERIFIED"  # UNVERIFIED, VERIFIED, MERGED, EXPIRED
    category: str  # í™˜ê²½, ëª©í‘œ, ì‚°ì¶œë¬¼, ì œì•½
    content: str
    source: str = "USER_UTTERANCE"
    timestamp: datetime
    ttl_days: int = 7
```

#### **2-2. Draft ì €ì¥ì†Œ (PostgreSQL)**
```sql
CREATE TABLE drafts (
    id UUID PRIMARY KEY,
    session_id VARCHAR(255) NOT NULL,
    user_id VARCHAR(255) NOT NULL,
    project_id VARCHAR(255),
    status VARCHAR(50) DEFAULT 'UNVERIFIED',
    category VARCHAR(50) NOT NULL,
    content TEXT NOT NULL,
    source VARCHAR(50) DEFAULT 'USER_UTTERANCE',
    timestamp TIMESTAMP DEFAULT NOW(),
    ttl_days INTEGER DEFAULT 7,
    INDEX idx_session (session_id),
    INDEX idx_status (status),
    INDEX idx_timestamp (timestamp)
);
```

#### **2-3. Shadow Mining ì—”ì§„**
```python
# backend/app/services/shadow_mining.py
async def extract_design_info(user_input: str, llm_client) -> List[Draft]:
    """ìì—°ì–´ì—ì„œ ì„¤ê³„ ì •ë³´ ì¶”ì¶œ"""
    prompt = f"""
    ì‚¬ìš©ì ì…ë ¥: "{user_input}"
    
    ìœ„ ì…ë ¥ì—ì„œ í”„ë¡œì íŠ¸ ì„¤ê³„ ê´€ë ¨ ì •ë³´ë¥¼ ì¶”ì¶œí•˜ì„¸ìš”.
    ì¹´í…Œê³ ë¦¬: í™˜ê²½, ëª©í‘œ, ì‚°ì¶œë¬¼, ì œì•½
    
    JSON ë°°ì—´ë¡œ ë°˜í™˜:
    [
        {{"category": "í™˜ê²½", "content": "ë¡œì»¬, íŒŒì´ì¬"}},
        {{"category": "ì‚°ì¶œë¬¼", "content": "now.py íŒŒì¼"}}
    ]
    
    ì„¤ê³„ ì •ë³´ê°€ ì—†ìœ¼ë©´ ë¹ˆ ë°°ì—´ ë°˜í™˜.
    """
    # LLM í˜¸ì¶œ ë° íŒŒì‹±
    ...
```

#### **ë‚œì´ë„:** â­â­â­â­â­ (5/5)
#### **ì˜ˆìƒ ì‹œê°„:** 6-8ì‹œê°„
#### **ë¦¬ìŠ¤í¬:** ğŸ”´ ë†’ìŒ (ì‹ ê·œ ì‹œìŠ¤í…œ, DB ë§ˆì´ê·¸ë ˆì´ì…˜ í•„ìš”)

---

### **Phase 3: VERIFIED ì‹œìŠ¤í…œ ê°•í™”**

#### **3-1. ARMED â†’ VERIFIED ë§ˆì´ê·¸ë ˆì´ì…˜**
```python
# backend/app/services/master_agent_service.py
class MasterAgentService:
    def __init__(self):
        # [v2.2] ê¸°ì¡´
        # self.is_armed: bool = False
        # self.armed_mes_hash: Optional[str] = None
        
        # [v3.2] ì‹ ê·œ
        self.verification_state = {
            "is_verified": False,
            "mes_hash": None,
            "last_db_check": None,  # timestamp
            "db_check_result": None,  # Tool í˜¸ì¶œ ê²°ê³¼
            "confirm_token": None
        }
```

#### **3-2. ì‹¤ì‹œê°„ DB ê²€ì¦**
```python
async def verify_execution_ready(self, project_id: str, confirm_token: str) -> Dict[str, Any]:
    """ì‹¤í–‰ ì¤€ë¹„ ìƒíƒœ ê²€ì¦ (VERIFIED ì¡°ê±´ ì²´í¬)"""
    # 1. confirm_token ê²€ì¦
    if confirm_token not in ["ì‹¤í–‰ í™•ì •", "ë³€ê²½ í™•ì •", "START TASK ì‹¤í–‰"]:
        return {"verified": False, "reason": "ì˜ëª»ëœ í™•ì • í† í°"}
    
    # 2. ì‹¤ì‹œê°„ DB ì¡°íšŒ
    try:
        project = await neo4j_client.get_project(project_id)
        if not project or not project.get("agent_config"):
            return {"verified": False, "reason": "í”„ë¡œì íŠ¸ ì¡°íšŒ ì‹¤íŒ¨"}
    except Exception as e:
        return {"verified": False, "reason": f"DB ì˜¤ë¥˜: {str(e)}"}
    
    # 3. ì™„ì „ì„± ì²´í¬
    check = self._check_completeness(project)
    if not check["is_complete"]:
        return {"verified": False, "reason": f"ì„¤ì • ë¯¸ì™„ë£Œ: {check['missing']}"}
    
    # 4. ì‹¤í–‰ ê°€ëŠ¥ì„± ì²´í¬
    capability = await self._check_agent_capability(project_id, "")
    if not capability["can_execute"]:
        return {"verified": False, "reason": f"ì‹¤í–‰ ë¶ˆê°€: {capability['issues']}"}
    
    # ëª¨ë“  ê²€ì¦ í†µê³¼
    self.verification_state["is_verified"] = True
    self.verification_state["mes_hash"] = self._get_mes_hash(project)
    self.verification_state["last_db_check"] = datetime.now()
    self.verification_state["confirm_token"] = confirm_token
    
    return {"verified": True}
```

#### **ë‚œì´ë„:** â­â­â­ (3/5)
#### **ì˜ˆìƒ ì‹œê°„:** 2-3ì‹œê°„
#### **ë¦¬ìŠ¤í¬:** ğŸŸ¡ ì¤‘ê°„ (ê¸°ì¡´ ARMED ë¡œì§ êµì²´)

---

### **Phase 4: Response Builder í›„ì²˜ë¦¬ ê°•í™”**

#### **4-1. ì¡°ê±´ë¶€ ë¸”ë¡ ì œê±°**
```python
# backend/app/services/master_agent_service.py
def clean_response(
    self, 
    content: str, 
    intent: MasterIntent, 
    has_confirm_token: bool
) -> str:
    """v3.2 Response Builder - ì¡°ê±´ë¶€ ë¸”ë¡ ì œê±°"""
    
    # FUNCTION_WRITE + confirm_token ìˆì„ ë•Œë§Œ ë³´ê³ ì„œ/JSON ìœ ì§€
    if intent == MasterIntent.FUNCTION_WRITE and has_confirm_token:
        return content
    
    # ê·¸ ì™¸ ëª¨ë“  ê²½ìš°: ìë™ ìƒì„± ë¸”ë¡ ì œê±°
    patterns = [
        r"---\s*MISSION READINESS REPORT\s*---[\s\S]*?(?=\n\n|\Z)",
        r'```json\s*\{\s*"status"\s*:\s*"READY_TO_START"[\s\S]*?```',
        r"## ì¡°ì¹˜ ë°©ë²• ê°€ì´ë“œ[\s\S]*?(?=\n\n|\Z)",
        r"\*\*ê¶Œì¥ ì¡°ì¹˜:\*\*[\s\S]*?(?=\n\n|\Z)",
    ]
    
    for pattern in patterns:
        content = re.sub(pattern, "", content, flags=re.MULTILINE)
    
    return content.strip()
```

#### **ë‚œì´ë„:** â­â­ (2/5)
#### **ì˜ˆìƒ ì‹œê°„:** 1ì‹œê°„
#### **ë¦¬ìŠ¤í¬:** ğŸŸ¢ ë‚®ìŒ (ê¸°ì¡´ ë¡œì§ ê°•í™”)

---

### **Phase 5: TTL ë° ì •ë¦¬ ì •ì±…**

#### **5-1. Draft TTL ê´€ë¦¬**
```python
# backend/app/services/draft_cleanup.py
import asyncio
from datetime import datetime, timedelta

async def cleanup_expired_drafts():
    """ë§Œë£Œëœ Draft ì‚­ì œ (TTL ê¸°ë°˜)"""
    while True:
        try:
            expired_time = datetime.now() - timedelta(days=7)
            # PostgreSQL
            await db.execute(
                "DELETE FROM drafts WHERE status = 'UNVERIFIED' AND timestamp < :expired",
                {"expired": expired_time}
            )
        except Exception as e:
            logger.error(f"Draft cleanup ì‹¤íŒ¨: {e}")
        
        await asyncio.sleep(3600)  # 1ì‹œê°„ë§ˆë‹¤ ì‹¤í–‰
```

#### **5-2. í”„ë¡œì íŠ¸ ì™„ë£Œ ì‹œ Draft purge**
```python
# backend/app/services/project_service.py
async def complete_project(project_id: str):
    """í”„ë¡œì íŠ¸ ì™„ë£Œ ì‹œ ê´€ë ¨ Draft ì •ë¦¬"""
    await db.execute(
        "UPDATE drafts SET status = 'EXPIRED' WHERE project_id = :project_id",
        {"project_id": project_id}
    )
```

#### **ë‚œì´ë„:** â­â­â­ (3/5)
#### **ì˜ˆìƒ ì‹œê°„:** 2-3ì‹œê°„
#### **ë¦¬ìŠ¤í¬:** ğŸŸ¡ ì¤‘ê°„ (ë°±ê·¸ë¼ìš´ë“œ ì‘ì—… ì¶”ê°€)

---

## ğŸ“Š **ë§ˆì´ê·¸ë ˆì´ì…˜ ì¼ì • (ì˜ˆìƒ)**

| Phase | ì‘ì—… ë‚´ìš© | ì˜ˆìƒ ì‹œê°„ | ë‚œì´ë„ | ìš°ì„ ìˆœìœ„ |
|-------|----------|----------|--------|----------|
| **Phase 1** | ì¸í…íŠ¸ ì²´ê³„ ì¬ì„¤ê³„ | 1-2ì‹œê°„ | â­â­â­ | ğŸ”¥ ìµœìš°ì„  |
| **Phase 2** | Shadow Mining êµ¬ì¶• | 6-8ì‹œê°„ | â­â­â­â­â­ | ğŸ”¥ ë†’ìŒ |
| **Phase 3** | VERIFIED ì‹œìŠ¤í…œ ê°•í™” | 2-3ì‹œê°„ | â­â­â­ | ğŸ”¥ ë†’ìŒ |
| **Phase 4** | Response Builder í›„ì²˜ë¦¬ | 1ì‹œê°„ | â­â­ | ğŸŸ¡ ì¤‘ê°„ |
| **Phase 5** | TTL ë° ì •ë¦¬ ì •ì±… | 2-3ì‹œê°„ | â­â­â­ | ğŸŸ¢ ë‚®ìŒ |

**ì´ ì˜ˆìƒ ì‹œê°„:** 12-17ì‹œê°„

---

## ğŸš¨ **ë¦¬ìŠ¤í¬ ë¶„ì„**

### **ë†’ì€ ë¦¬ìŠ¤í¬ í•­ëª©**
1. **Shadow Mining ì‹œìŠ¤í…œ (Phase 2)**
   - ì‹ ê·œ DB í…Œì´ë¸” ì¶”ê°€ (ë§ˆì´ê·¸ë ˆì´ì…˜ í•„ìš”)
   - LLM í˜¸ì¶œ ì¶”ê°€ (ë¹„ìš© ë° ë ˆì´í„´ì‹œ ì¦ê°€)
   - Draft â†’ MES ë§¤ì¹­ ë¡œì§ ë³µì¡ë„

2. **ì¸í…íŠ¸ ì²´ê³„ ì¬ì„¤ê³„ (Phase 1)**
   - ê¸°ì¡´ 11ê°€ì§€ â†’ 5ê°€ì§€ë¡œ ëŒ€í­ ì¶•ì†Œ
   - ëª¨ë“  Intent ì²˜ë¦¬ ë¡œì§ ìˆ˜ì • í•„ìš”
   - ê¸°ì¡´ í”„ë¡œì íŠ¸ í˜¸í™˜ì„± ê²€ì¦ í•„ìˆ˜

### **ì¤‘ê°„ ë¦¬ìŠ¤í¬ í•­ëª©**
3. **VERIFIED ì‹œìŠ¤í…œ (Phase 3)**
   - ARMED ë¡œì§ ì™„ì „ êµì²´
   - ì‹¤ì‹œê°„ DB ê²€ì¦ ì¶”ê°€ (ì„±ëŠ¥ ì˜í–¥)

### **ë‚®ì€ ë¦¬ìŠ¤í¬ í•­ëª©**
4. **Response Builder (Phase 4)**
   - ê¸°ì¡´ ë¡œì§ ê°•í™” (êµì²´ ì•„ë‹˜)
5. **TTL ì •ì±… (Phase 5)**
   - ë…ë¦½ì  ë°±ê·¸ë¼ìš´ë“œ ì‘ì—…

---

## âœ… **ê¶Œì¥ ë§ˆì´ê·¸ë ˆì´ì…˜ ê²½ë¡œ**

### **ì˜µì…˜ 1: ì ì§„ì  ë§ˆì´ê·¸ë ˆì´ì…˜ (ê¶Œì¥)**
```
ì£¼ì°¨ 1: Phase 1 (ì¸í…íŠ¸ ì¬ì„¤ê³„) + Phase 4 (Response Builder)
  â†’ ë¹ ë¥¸ UX ê°œì„ , ë¦¬ìŠ¤í¬ ë‚®ìŒ
  
ì£¼ì°¨ 2: Phase 3 (VERIFIED ê°•í™”)
  â†’ ì•ˆì •ì„± ê°œì„ 
  
ì£¼ì°¨ 3-4: Phase 2 (Shadow Mining)
  â†’ ê°€ì¥ ë³µì¡í•œ ê¸°ëŠ¥, ì¶©ë¶„í•œ ì‹œê°„ í™•ë³´
  
ì£¼ì°¨ 5: Phase 5 (TTL ì •ì±…) + í†µí•© í…ŒìŠ¤íŠ¸
```

### **ì˜µì…˜ 2: ë¹…ë±… ë§ˆì´ê·¸ë ˆì´ì…˜**
```
ì¼ì‹œ: 3-4ì¼ ì§‘ì¤‘ ì‘ì—…
ì¥ì : í•œ ë²ˆì— v3.2 ì™„ì„±
ë‹¨ì : ë†’ì€ ë¦¬ìŠ¤í¬, ë¡¤ë°± ì–´ë ¤ì›€
```

### **ì˜µì…˜ 3: MVP ìš°ì„  (ìµœì†Œ ê¸°ëŠ¥)**
```
1ì¼ì°¨: Phase 1 (ì¸í…íŠ¸ ì¬ì„¤ê³„) ë§Œ êµ¬í˜„
  â†’ NATURAL Intent ì²˜ë¦¬ë¡œ UX ê°œì„ 
  â†’ Shadow Mining ì—†ì´ë„ ìì—°ìŠ¤ëŸ¬ìš´ ëŒ€í™” ê°€ëŠ¥
  
ì´í›„: ì‚¬ìš©ì í”¼ë“œë°± ê¸°ë°˜ Phase 2-5 ì¶”ê°€
```

---

## ğŸ¯ **ì¦‰ì‹œ ì‹¤í–‰ ê°€ëŠ¥í•œ Quick Win**

### **1. NATURAL Intent ì²˜ë¦¬ (30ë¶„)**
```python
# _classify_intentì— ì¶”ê°€
if re.search(r"^(ì•ˆë…•|í•˜ì´|ê³ ë§ˆì›Œ|ã…‹ã…‹)$", message):
    return "NATURAL"

# stream_messageì— ì¶”ê°€
if intent == "NATURAL":
    natural_responses = {
        "ì•ˆë…•": "ì•ˆë…•í•˜ì„¸ìš”, í˜•ë‹˜! ğŸ˜Š",
        "ê³ ë§ˆì›Œ": "ë³„ë§ì”€ì„ìš”! ë„ì›€ì´ ë˜ì–´ ê¸°ì©ë‹ˆë‹¤.",
        "ã…‹ã…‹": "ã…ã… ğŸ˜„"
    }
    response = natural_responses.get(message.strip(), "ë„¤, í˜•ë‹˜!")
    yield response
    await save_message_to_rdb("assistant", response, project_id, thread_id)
    return
```

### **2. confirm_token ì—„ê²©í™” (15ë¶„)**
```python
# _classify_intentì—ì„œ
CONFIRM_TOKENS = ["ì‹¤í–‰ í™•ì •", "ë³€ê²½ í™•ì •", "START TASK ì‹¤í–‰"]
if any(token in message for token in CONFIRM_TOKENS):
    return "EXECUTION_REQUEST"
```

### **3. Response Builder íŒ¨í„´ ì¶”ê°€ (10ë¶„)**
```python
# stream_message ëë¶€ë¶„ì—
patterns = [
    r"## ì¡°ì¹˜ ë°©ë²• ê°€ì´ë“œ[\s\S]*?(?=\n\n|\Z)",
    r"\*\*ê¶Œì¥ ì¡°ì¹˜:\*\*[\s\S]*?(?=\n\n|\Z)",
]
for pattern in patterns:
    full_content = re.sub(pattern, "", full_content)
```

**ì´ ì‹œê°„: 1ì‹œê°„ ì´ë‚´**
**íš¨ê³¼: ì¦‰ì‹œ ì²´ê° ê°€ëŠ¥í•œ UX ê°œì„ **

---

## ğŸ“ **ë‹¤ìŒ ì•¡ì…˜ (í˜•ë‹˜ ì„ íƒ í•„ìš”)**

### **ì§ˆë¬¸ 1: ë§ˆì´ê·¸ë ˆì´ì…˜ ë°©ì‹**
- A. **ì ì§„ì  ë§ˆì´ê·¸ë ˆì´ì…˜** (ê¶Œì¥) - ì£¼ì°¨ë³„ë¡œ Phase 1 â†’ 5 ìˆœì°¨ ì§„í–‰
- B. **ë¹…ë±… ë§ˆì´ê·¸ë ˆì´ì…˜** - 3-4ì¼ ì§‘ì¤‘ ì‘ì—…ìœ¼ë¡œ v3.2 ì™„ì„±
- C. **MVP ìš°ì„ ** - Phase 1ë§Œ ë¨¼ì € êµ¬í˜„, ë‚˜ë¨¸ì§€ëŠ” í”¼ë“œë°± í›„ ê²°ì •
- D. **Quick Win ë¨¼ì €** - 1ì‹œê°„ ë‚´ ê°€ëŠ¥í•œ ê°œì„ ë¶€í„° ì ìš©

### **ì§ˆë¬¸ 2: Shadow Mining í•„ìš”ì„±**
- Shadow Mining (Draft ì‹œìŠ¤í…œ)ì€ v3.2ì˜ í•µì‹¬ì´ì§€ë§Œ ê°€ì¥ ë³µì¡í•©ë‹ˆë‹¤.
- ì´ê²ƒ ì—†ì´ë„ ì¸í…íŠ¸ ì¬ì„¤ê³„ + VERIFIED ê°•í™”ë§Œìœ¼ë¡œë„ í° ê°œì„ ì´ ê°€ëŠ¥í•©ë‹ˆë‹¤.
- Shadow Miningì„ **ì§€ê¸ˆ êµ¬ì¶•** vs **ë‚˜ì¤‘ì— ì¶”ê°€**?

### **ì§ˆë¬¸ 3: ê¸°ì¡´ í”„ë¡œì íŠ¸ í˜¸í™˜ì„±**
- v3.2ë¡œ ì „í™˜ ì‹œ ê¸°ì¡´ í”„ë¡œì íŠ¸ (real-task-01, ë¸”ë¡œê·¸ ìˆ˜ì • ë“±)ì˜ ë™ì‘ ë³€ê²½ ê°€ëŠ¥
- **ê¸°ì¡´ í”„ë¡œì íŠ¸ ìœ ì§€** vs **ìƒˆë¡œìš´ í”„ë¡œì íŠ¸ë§Œ v3.2 ì ìš©**?

---

**END OF ANALYSIS**
