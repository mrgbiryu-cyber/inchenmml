# 검증용 시각화 리팩토링 v4.2 완료 보고서

**작업일시**: 2026-01-28
**상태**: ✅ 완료 (Production Ready)
**대상**: Backend (FastAPI), Frontend (Next.js)

---

## 🎯 달성 목표

Admin 전용 검증 엔진("Audit Engine")을 기존 시스템(8002 포트, 스트리밍)을 100% 유지한 채 **사이드카(Sidecar)** 형태로 완벽하게 이식했습니다.

## 🛠️ 아키텍처 변경 상세

### 1. [Backend] Debug Data Pipeline (신설)
- **Debug Service**: Redis 기반 TTL 캐시(10분) 구현. 검증 데이터는 메인 DB를 오염시키지 않고 메모리에만 잠시 머뭅니다.
- **X-Request-Id**: 모든 채팅 요청에 UUID를 발급하여 헤더에 주입. 이것이 **Audit Trace Key**가 됩니다.
- **Silent Capture**: `stream_message_v32` 내부에서 Admin 요청인 경우에만 Vector 검색 결과를 조용히 캡처하여 Redis에 저장합니다.

### 2. [Backend] API Security & Protocol
- **`/chat-stream`**: 기존 `text/plain` 스트리밍 프로토콜을 절대 준수합니다. 메타데이터는 오직 **Header**(`X-Request-Id`)를 통해서만 전달됩니다.
- **`/chat_debug`**: Admin 전용 엔드포인트 신설. (`/api/v1/master/chat_debug?request_id=...`)
  - 일반 사용자 접근 시: `403 Forbidden`
  - 만료된 데이터 접근 시: `404 Not Found`

### 3. [Frontend] Admin-Only UX
- **Source Bar**: 일반 사용자에게는 보이지 않습니다. Admin 계정(`super_admin`) 로그인 시에만 답변 하단에 `[Vector] [Graph]` 링크가 나타납니다.
- **Auto-Focus Visualization**: 탭 전환(`?tab=vector`) 시 `request_id`를 기반으로 백엔드에서 원문(Chunk)을 조회하여, LLM이 실제로 참고한 근거를 Top 1부터 하이라이트하여 보여줍니다.

---

## 🏗️ [Addendum] UX 정렬 및 보강 (Refinement)

초기 구현 후, **기존 UX 구조(탭)를 유지하며 검증 흐름을 자연스럽게 통합(Align)**하는 보강 작업을 수행했습니다.

### 1. API 경로 통일 (Verification Point 1)
백엔드 실제 엔드포인트 규격에 맞춰 모든 프론트엔드 호출부를 Query Parameter 방식으로 통일했습니다.
- **적용**: `/master/chat_debug?request_id=...`
- **적용 파일**:
  - `ChatInterface.tsx` (Line 37): `api.get('/master/chat_debug', { params: { request_id: requestId } ... })`
  - `VectorMapView.tsx` (Line 70): `api.get('/master/chat_debug', { params: { request_id: requestId } ... })`
  - `KnowledgeGraph.tsx` (Line 85): `api.get('/master/chat_debug', { params: { request_id: requestId } ... })`

### 2. MessageAuditBar Lazy Loading (Verification Point 2)
Admin 출처 바(`MessageAuditBar`)는 메인 스트리밍에 영향을 주지 않도록 **Lazy Loading** 패턴을 적용했습니다.
- **동작 방식**: 스트리밍이 끝나고 컴포넌트가 마운트(`useEffect`)되는 시점에 비동기로 `fetchStats`를 호출합니다.
- **코드 위치**: `frontend/src/components/chat/ChatInterface.tsx` 내 `MessageAuditBar` 컴포넌트 (Line 32 useEffect).

### 3. 탭 전환 및 Deep Linking (Verification Point 3)
단순 상태 변경이 아닌 Next.js Router를 사용하여 URL State를 동기화했습니다.
- **구현**: `router.push('?tab=vector&request_id=...', { scroll: false })` 사용.
- **효과**:
  - 페이지 전체 리로드 없이 부드럽게 탭이 전환됩니다.
  - URL에 `request_id`가 명시되므로 **새로고침(F5)을 하거나 링크를 공유해도 검증 상태(Highlight)가 유지**됩니다.

### 4. Silent Failure 원칙 준수 (Verification Point 4)
Admin 검증 데이터 로드 실패가 일반 사용자 경험이나 콘솔 로그를 오염시키지 않도록 방어했습니다.
- **방어 로직**: 403/404/네트워크 오류 발생 시 `catch` 블록에서 에러 UI를 띄우지 않고 상태를 `null`로 조용히 처리합니다.
- **코드 증거**: `ChatInterface.tsx` Line 53 (`if (isMounted) setStats(null)`), `VectorMapView.tsx` Line 77 (`setDebugInfo(null)`).

### 5. CORS 및 헤더 노출 (Verification Point 5)
프론트엔드에서 `X-Request-Id` 헤더를 읽을 수 있도록 백엔드 설정을 완료했습니다.
- **설정 파일**: `backend/app/api/v1/master.py`
- **코드**: `response.headers["Access-Control-Expose-Headers"] = "X-Request-Id"` (Line 92).

### 6. debug_info Schema 및 정렬 (Verification Point 6)
- **Schema**: `retrieval.chunks`는 `{rank, score, title, text, source_message_id}` 필드를 포함합니다.
- **정렬 보장**: 프론트엔드 `VectorMapView.tsx`에서 데이터를 받자마자 `sort((a, b) => b.score - a.score)`를 수행하여(Line 73) 시각화의 정확성을 보장합니다.

### 7. metadata.text 원문 보존 (Verification Point 7)
Vector DB 임베딩 시, LLM 요약본이 아닌 **청크 원문(Original Text)**을 메타데이터에 저장하도록 조치했습니다.
- **적용 파일**: `backend/app/services/knowledge_service.py`
- **수정 내역**: `_upsert_to_neo4j` 및 `_upsert_batch_to_neo4j` 함수 내 metadata 생성 로직에 `"text": embed_text[:4000]` 추가.
- **제약 사항**: 4000자 초과 시 자동으로 잘라서 저장하여 Vector DB 용량 제한을 준수합니다.

---

**작성자**: MYLLM Development Team